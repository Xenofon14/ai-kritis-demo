// ===============================
// API ENDPOINT: /api/score
// AI ÎšÏÎ¹Ï„Î®Ï‚ "Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚" (ÏƒÏ„Î±Î¸ÎµÏÎ® JSON Î±Ï€ÏŒÎºÏÎ¹ÏƒÎ·)
// ===============================

import OpenAI from "openai";

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export default async function handler(req, res) {
  try {
    // --- Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· body (Î±ÏƒÏ†Î±Î»Î®Ï‚ Î³Î¹Î± Edge functions) ---
    let body = {};
    try {
      if (req.body) {
        body = req.body;
      } else {
        let raw = "";
        for await (const chunk of req) raw += chunk;
        body = JSON.parse(raw || "{}");
      }
    } catch (err) {
      console.error("âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ body:", err);
      return res.status(400).json({ error: "ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î¼Î¿ÏÏ†Î® Î±Î¹Ï„Î®Î¼Î±Ï„Î¿Ï‚." });
    }

    const { transcript, mission, round, mode } = body;
    if (!transcript) {
      return res.status(400).json({ error: "ÎšÎ±Î¼Î¯Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î³Î¹Î± Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·." });
    }

    // --- Round & Mode ---
    const roundNum = Number(round) || 1;
    const isFirstRound = roundNum === 1;
    const isAdvanced = (mode === "advanced");

    // --- Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® rubric Î±Î½Î¬ Î­ÎºÎ´Î¿ÏƒÎ· ---
    // ÎšÎ»ÎµÎ¹Î´Î¹Î¬ Î½Î­Î¿Ï… rubric:
    // Î˜Î­ÏƒÎ· (0â€“4, Î¼ÏŒÎ½Î¿ 1Î¿Ï‚ Î³ÏÏÎ¿Ï‚), Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î± (0â€“6, ÏŒÎ»Î¿Î¹ Î¿Î¹ Î³ÏÏÎ¿Î¹),
    // Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ (0â€“4, ÏŒÎ»Î¿Î¹ Î¿Î¹ Î³ÏÏÎ¿Î¹), Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± (0â€“3, Î¼ÏŒÎ½Î¿ advanced),
    // Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ· (0â€“4, Î±Ï€ÏŒ 2Î¿ Î³ÏÏÎ¿).
    const rubricText = isAdvanced
      ? `ÎšÏÎ¹Ï„Î®ÏÎ¹Î± (Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ·):
- Î˜Î­ÏƒÎ·: 0â€“4 (Î¼ÏŒÎ½Î¿ 1Î¿Ï‚ Î³ÏÏÎ¿Ï‚Â· ÏƒÏ„Î¿Ï…Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Î³ÏÏÎ¿Ï…Ï‚ Î´ÎµÎ½ Ï€ÏÎ¿ÏƒÎ¼ÎµÏ„ÏÎ¬Ï„Î±Î¹)
- Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±: 0â€“6
- Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬: 0â€“4
- Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±: 0â€“3
- Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·: 0â€“4 (Î¼ÏŒÎ½Î¿ Î±Ï€ÏŒ 2Î¿ Î³ÏÏÎ¿ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬)`
      : `ÎšÏÎ¹Ï„Î®ÏÎ¹Î± (Î‘Ï€Î»Î® ÎˆÎºÎ´Î¿ÏƒÎ·):
- Î˜Î­ÏƒÎ·: 0â€“4 (Î¼ÏŒÎ½Î¿ 1Î¿Ï‚ Î³ÏÏÎ¿Ï‚Â· ÏƒÏ„Î¿Ï…Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Î³ÏÏÎ¿Ï…Ï‚ Î´ÎµÎ½ Ï€ÏÎ¿ÏƒÎ¼ÎµÏ„ÏÎ¬Ï„Î±Î¹)
- Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±: 0â€“6
- Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬: 0â€“4
- Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·: 0â€“4 (Î¼ÏŒÎ½Î¿ Î±Ï€ÏŒ 2Î¿ Î³ÏÏÎ¿ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬)
(Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿ "Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±"Â· Î¸ÎµÏÏÎ·ÏƒÎ­ Ï„Î¿ 0)`;


    
    // --- Prompt Ï€ÏÎ¿Ï‚ Ï„Î¿ Î¼Î¿Î½Ï„Î­Î»Î¿ ---
    const completion = await client.chat.completions.create({
      model: "gpt-4-turbo",
      temperature: 0,
      max_tokens: 250,
      messages: [
        {
          role: "system",
          content: `
Î•Î¯ÏƒÎ±Î¹ Î¿ Ï†Î¹Î»ÏŒÏƒÎ¿Ï†Î¿Ï‚ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚.
Î‘Ï€Î¬Î½Ï„Î·ÏƒÎµ *Î¼ÏŒÎ½Î¿* Î¼Îµ Î­Î³ÎºÏ…ÏÎ¿ JSON, ÏƒÏ„Î· ÎœÎŸÎ¡Î¦Î—:
{
  "criteria": {
    "Î˜Î­ÏƒÎ·": 0-4,
    "Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±": 0-6,
    "Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬": 0-4,
    "Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±": 0-3,
    "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·": 0-4
  },
  "feedback": "ÎºÎµÎ¯Î¼ÎµÎ½Î¿"
}

ÎšÎ±Î½ÏŒÎ½ÎµÏ‚:
- "${isAdvanced ? "Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î·" : "Î‘Ï€Î»Î®"}" Î­ÎºÎ´Î¿ÏƒÎ·.
- ÎœÎŸÎÎŸ ÏƒÏ„Î¿Î½ 1Î¿ Î³ÏÏÎ¿ Î²Î±Î¸Î¼Î¿Î»Î¿Î³ÎµÎ¯Ï„Î±Î¹ Î· "Î˜Î­ÏƒÎ·". Î£Îµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Î³ÏÏÎ¿Ï…Ï‚ Î²Î¬Î»Îµ "Î˜Î­ÏƒÎ·": 0.
- Î— "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·" Î²Î±Î¸Î¼Î¿Î»Î¿Î³ÎµÎ¯Ï„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ Ï„Î¿Î½ 2Î¿ Î³ÏÏÎ¿ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬. Î£Ï„Î¿Î½ 1Î¿ Î³ÏÏÎ¿ Î²Î¬Î»Îµ "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·": 0.
- Î£Ï„Î·Î½ Î‘Ï€Î»Î® ÎˆÎºÎ´Î¿ÏƒÎ· Ï„Î¿ "Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±" Î¸ÎµÏ‰ÏÎµÎ¯Ï„Î±Î¹ 0 (Î¼Î· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿).
- ${rubricText}

ÎœÎ·Î½ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹Ï‚ Ï„Î¯Ï€Î¿Ï„Î± Î¬Î»Î»Î¿ ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿ JSON.
`
        },
        {
          role: "user",
          content: `
Î“ÏÏÎ¿Ï‚: ${roundNum}
ÎˆÎºÎ´Î¿ÏƒÎ·: ${isAdvanced ? "Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î·" : "Î‘Ï€Î»Î®"}
Î•ÏÏÏ„Î·Î¼Î±: ${mission?.question || "â€”"}
Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·: ${transcript}`
        }
      ]


      
    });

    // --- Î‘Î½Î¬Î³Î½Ï‰ÏƒÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ ---
   const raw = completion.choices?.[0]?.message?.content || "{}";
let parsed = {};

try {
  // ÎšÎ±Î½Î¿Î½Î¹ÎºÎ® Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±
  parsed = JSON.parse(raw);
} catch (err) {
  console.warn("âš ï¸ JSON parse error, ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÏ Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·â€¦");

  // ğŸ’Š Î•Ï€Î¹Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· ÎºÎ¿Î¹Î½ÏÎ½ ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½ JSON Î±Ï€ÏŒ Ï„Î¿ Î¼Î¿Î½Ï„Î­Î»Î¿
  let fixed = raw.trim()
    .replace(/[\u0000-\u001F]+/g, "")        // Î±Ï†Î±Î¹ÏÎµÎ¯ Î±ÏŒÏÎ±Ï„Î¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚
    .replace(/â€œ|â€/g, '"')                    // Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¬ ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î¹ÎºÎ¬
    .replace(/(\w)"(\w)/g, '$1"$2')          // Î´Î¹Î¿ÏÎ¸ÏÎ½ÎµÎ¹ â€œÎºÎ¿Î»Î»Î·Ï„Î¬â€ ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î¹ÎºÎ¬
    .replace(/,$/, "")                       // Î±Ï†Î±Î¹ÏÎµÎ¯ ÎºÏŒÎ¼Î¼Î± ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚
    .replace(/"feedback":"([^"]*)$/, '"feedback":"$1"}'); // ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ feedback

  try {
    parsed = JSON.parse(fixed);
  } catch {
    console.error("âš ï¸ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Ï„Î· Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·:", fixed);
    parsed = { criteria: {}, feedback: "âš ï¸ JSON error" };
  }
}


       // --- Î•ÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ® Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· (ÎÎ•ÎŸ rubric) ---
    const c = parsed.criteria || {};

    // Î¤Î¹Î¼Î­Ï‚ Î±Ï€ÏŒ Ï„Î¿ Î¼Î¿Î½Ï„Î­Î»Î¿ (Î¼Îµ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± NaN)
    let scores = {
      "Î˜Î­ÏƒÎ·": Number(c["Î˜Î­ÏƒÎ·"]) || 0,
      "Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±": Number(c["Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±"]) || 0,
      "Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬": Number(c["Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬"]) || 0,
      "Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±": Number(c["Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±"]) || 0,
      "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·": Number(c["Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·"]) || 0
    };

    // Weights
    const WEIGHTS = {
      "Î˜Î­ÏƒÎ·": 4,
      "Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±": 6,
      "Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬": 4,
      "Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±": (isAdvanced ? 3 : 0),
      "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·": 4
    };

    // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ Î³ÏÏÎ¿
    if (isFirstRound) {
      // 1Î¿Ï‚ Î³ÏÏÎ¿Ï‚: Î´ÎµÎ½ Î¼ÎµÏ„ÏÎ¬ Î· Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·
      scores["Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·"] = 0;
    } else {
      // 2Î¿Ï‚+ Î³ÏÏÎ¿Ï‚: Î´ÎµÎ½ Î¼ÎµÏ„ÏÎ¬ Î· Î˜Î­ÏƒÎ·
      scores["Î˜Î­ÏƒÎ·"] = 0;
    }

    // Î£Ï„Î·Î½ Î‘Ï€Î»Î®: Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± = 0
    if (!isAdvanced) {
      scores["Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±"] = 0;
    }

    // ÎšÎ»Î¬Î¼Ï€Î¹Î½Î³Îº Î±Î½Î¬ weight
    const clamped = Object.fromEntries(
      Object.entries(scores).map(([k, v]) => [k, Math.max(0, Math.min(v, WEIGHTS[k]))])
    );

    // Î£ÏÎ½Î¿Î»Î¿ & out_of
    const out_of = (isAdvanced ? 17 : 14); // Advanced: 6+4+3+(4 Î® 4) + Î˜Î­ÏƒÎ·/Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ· Î±Î½Î¬ Î³ÏÏÎ¿ => 17 max Î±Î½Î¬ Î³ÏÏÎ¿
    let total = Object.entries(clamped).reduce((sum, [k, v]) => sum + v, 0);

    // Î•Ï€Î¹Ï€Î»Î­Î¿Î½ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ® Î´Î¹ÎºÎ»ÎµÎ¯Î´Î±: Î¼Î· Î¾ÎµÏ€ÎµÏÎ½Î¬Ï‚ Ï„Î¿ Î¸ÎµÏ‰ÏÎ·Ï„Î¹ÎºÏŒ Î¼Î­Î³Î¹ÏƒÏ„Î¿ Î±Î½Î¬ Î³ÏÏÎ¿
    if (total > out_of) total = out_of;

    const scaled = Math.round((total / out_of) * 10);


    // --- Î¤ÎµÎ»Î¹ÎºÏŒ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± ---
    const result = {
      criteria: C,
      total,
      out_of: 8,
      scaled,
      feedback:
        typeof parsed.feedback === "string"
          ? parsed.feedback
          : "ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÎ¹ÏÏ€Î·ÏƒÎµ."
    };

    console.log(`ğŸ“Š Î£ÎºÎ¿Ï Î³ÏÏÎ¿Ï‚ ${roundNum}: ${total}/8 (${scaled}/10)`);

    return res.status(200).json(result);
  } catch (err) {
    console.error("âŒ Î£Ï†Î¬Î»Î¼Î± AI ÎšÏÎ¹Ï„Î®:", err);
    return res
      .status(500)
      .json({ error: err.message || "Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®." });
  }
}
