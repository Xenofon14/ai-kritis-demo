<!DOCTYPE html> 
<html lang="el">
<head>   
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI ÎšÏÎ¹Ï„Î®Ï‚ - Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ (Î£Ï„Î±Î¸ÎµÏÎ® Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± + Î£Ï‡ÏŒÎ»Î¹Î¿)</title>
  <style>  
    body { font-family: system-ui, Arial, sans-serif; background:#173b88; color:#fff; margin:0; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .app { background:#0e2a66; border-radius:20px; padding:20px; max-width:420px; width:100%; box-shadow:0 8px 24px rgba(0,0,0,.3); }
    h1 { font-size:22px; margin:0 0 5px 0; }
    h2 { font-size:18px; margin:0 0 12px 0; color:#cfe0ff; }
    select, textarea { width:100%; padding:10px; border-radius:10px; border:0; margin:10px 0; font-size:16px; }
    button { width:100%; padding:14px; border-radius:20px; border:0; font-size:18px; margin:10px 0; cursor:pointer; }
    .btn-primary { background:linear-gradient(135deg,#cde7ff,#caa5ff); color:#000; }
    .btn-secondary { background:linear-gradient(135deg,#6ee0ff,#3db8ff); color:#002140; }
  
  /* === ÎœÏ€Î¬ÏÎ± Ï‡ÏÏŒÎ½Î¿Ï… === */
#timeBarContainer {
  width: 100%;
  height: 10px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  margin-top: 8px;
  overflow: hidden;
}

#timeBar {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #4ef2a6, #f2c14e, #ef476f);
  transition: width 1s linear;
}

/* === Î•Ï†Î­ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ 10 Î´ÎµÏ…Ï„ÎµÏÎ¿Î»Î­Ï€Ï„Ï‰Î½ === */
@keyframes flashWarning {
  0% { filter: brightness(1); }
  50% { filter: brightness(2); }
  100% { filter: brightness(1); }
}

#timeBar.warning {
  background: linear-gradient(90deg, #ff6b6b, #ff0000);
  animation: flashWarning 1s infinite;
}

    /* === Î•Ï†Î­ Î±Î½Î±Ï€Î½Î¿Î®Ï‚ Î³Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î£Ï‰ÎºÏÎ¬Ï„Î· === */
@keyframes breathe {
  0% { box-shadow: 0 0 10px #ff4d4d; }
  50% { box-shadow: 0 0 25px #ff9a9a; }
  100% { box-shadow: 0 0 10px #ff4d4d; }
}

button.recording {
  animation: breathe 2s ease-in-out infinite;
}
    
/* === Î’ÎµÎ»Ï„Î¹Ï‰Î¼Î­Î½Î· ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€Î¯Î½Î±ÎºÎ± Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚ === */
.panel {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 15px;
  padding: 16px 18px;
  margin: 12px 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  backdrop-filter: blur(4px);
  transition: 0.3s ease;
}
.panel:hover {
  background: rgba(255, 255, 255, 0.12);
}

#criteriaPanel strong {
  color: #6ee0ff;
  font-size: 17px;
}

#criteriaList {
  list-style: none;
  margin: 0;
  padding: 0;
}

#criteriaList li {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 10px;
  padding: 6px 10px;
  margin-bottom: 6px;
  font-size: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;  /* âœ… ÎµÏ…Î¸Ï…Î³ÏÎ¬Î¼Î¼Î¹ÏƒÎ· bullet ÎºÎ±Î¹ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… */
}

#criteriaList li::before {
  content: "â€¢";
  color: #6ee0ff;
  margin-right: 6px;
}

#socraticComment {
  font-style: italic;
  color: #e0ecff;
  line-height: 1.5;
  font-size: 16px;
}

/* === Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ®Ï‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚ === */
#totalScore {
  text-align: center;
  background: linear-gradient(135deg, #ffd166, #ff7e5f);
  color: #001;
  border-radius: 20px;
  padding: 14px;
  margin-top: 15px;
  font-size: 26px;
  font-weight: 800;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

    .tiny { font-size:12px; color:#cfe0ff; opacity:.9 }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .recording { position: relative; }
    .recording::after{
      content:"";
      position:absolute;
      top:-6px; right:-6px;
      width:12px; height:12px;
      background:#ff4d4d; border-radius:50%;
      box-shadow:0 0 0 0 rgba(255,77,77,0.7);
      animation:pulse 1.4s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(255,77,77,0.7) }
      70%{ box-shadow:0 0 0 12px rgba(255,77,77,0) }
      100%{ box-shadow:0 0 0 0 rgba(255,77,77,0) }
    }

#timerPanel {
  background: rgba(255, 255, 255, 0.15);
  font-size: 18px;
  text-align: center;
  font-weight: bold;
  margin-top: 10px;
  border-radius: 12px;
  padding: 10px;
}

    /* === ÎÎ­Î¿Ï‚ ÏƒÏ‡ÎµÎ´Î¹Î±ÏƒÎ¼ÏŒÏ‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚ === */
#socraticPanel {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 15px;
  margin-top: 15px;
  position: relative;
  border-left: 4px solid #f2c14e;
}

.socrates-header {
  font-weight: 700;
  color: #f2c14e;
  margin-bottom: 8px;
}

.socrates-comment {
  font-style: italic;
  line-height: 1.4;
  color: #ffffff;
}

/* ÎšÏÎ¹Ï„Î®ÏÎ¹Î± */
#criteriaPanel {
  background: rgba(255,255,255,0.08);
  border-radius: 15px;
  margin-top: 15px;
  padding: 12px 15px;
}

.criteria-header {
  font-weight: 700;
  color: #6ee0ff;
  margin-bottom: 8px;
}

/* Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÏƒÎºÎ¿Ï */
#scorePanel {
  text-align: center;
  background: linear-gradient(135deg,#ffd166,#ff7e5f);
  border-radius: 20px;
  padding: 12px;
  margin-top: 15px;
  color: #001;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}

.score-label {
  font-size: 14px;
  font-weight: 700;
  opacity: 0.9;
}

.score-value {
  font-size: 26px;
  font-weight: 800;
}

    
#timer {
  color: #ffde59;
}

#activePlayerBar .tiny { opacity:.9; }
#activePlayerBar #bonusBtn[disabled] { opacity:.5; cursor:not-allowed; }

/* ÎšÎ¬Î½ÎµÎ¹ Ï„Î¿ setup screen scrollable */
#setupScreen {
  overflow-y: auto;
  max-height: 100vh;
}

/* Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÏŒÏ„Î±Î½ ÎµÏ€Î¹Î»Î­Î³ÎµÏ„Î±Î¹ Î­Î½Î±Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ±Ï‚ */
.character.selected {
  outline: 4px solid white;
  transform: scale(1.05);
  transition: 0.2s;
}

  /* === Î”Î¹Î¬Ï„Î±Î¾Î· Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÏ‰Î½ ÏƒÎµ Ï€Î»Î­Î³Î¼Î± === */
#characterSelection {
  display: grid !important;
  grid-template-columns: repeat(2, minmax(120px, 1fr));
  gap: 20px;
  justify-items: center;
  margin-top: 20px;
}

.character {
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 10px;
  text-align: center;
  width: 120px;
}

.character img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: contain;
  background-color: #ffffff;
  margin-bottom: 5px;
  padding: 3px;
  transition: transform 0.2s;
}

.character img:hover {
  transform: scale(1.08);
}

.character img:hover {
  transform: scale(1.08);
}

/* ğŸ¨ Î£Ï„Ï…Î» Î³Î¹Î± Ï„Î± Î½Î­Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® ÏƒÎµÎ»Î¯Î´Î± */
#startSimpleBtn, #startAdvancedBtn {
  background: white;
  color: #0e2a66;
  font-weight: 600;
  transition: transform 0.2s;
}
#startSimpleBtn:hover { transform: scale(1.05); background:#d6ffe0; }
#startAdvancedBtn:hover { transform: scale(1.05); background:#ffd6d6; }

/* === Î•Ï†Î­ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ popup Î£Ï‰ÎºÏÎ¬Ï„Î· === */
#socratesPopup {
  transition: opacity 1s, transform 1s;
  opacity: 0;
  transform: translateY(20px);
}

    
/* === Î•Ï†Î­ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ popup Î£Ï‰ÎºÏÎ¬Ï„Î· === */
#socratesPopup {
  transition: opacity 1s, transform 1s;
  opacity: 0;
  transform: translateY(20px);
}

#socratesPopup.show {
  opacity: 1;
  transform: translateY(0);
}

/* âœ¨ Î›Î¬Î¼ÏˆÎ· Î³ÏÏÏ‰ Î±Ï€ÏŒ Ï„Î¿ Ï€Î»Î±Î¯ÏƒÎ¹Î¿ */
@keyframes glowPulse {
  0% { box-shadow: 0 0 10px #6ee0ff, 0 0 20px #6ee0ff; }
  50% { box-shadow: 0 0 20px #6ee0ff, 0 0 30px #6ee0ff; }
  100% { box-shadow: 0 0 10px #6ee0ff, 0 0 20px #6ee0ff; }
}

#socratesPopup.glow {
  animation: glowPulse 2s infinite alternate;
}

/* === Glow Î³Î¹Î± Ï„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î® Î¤ÎµÏ‡Î½Î·Ï„Î®Ï‚ ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·Ï‚ === */
#useAICheckboxContainer {
  background: rgba(255,255,255,0.08);
  border-radius: 15px;
  padding: 12px 16px;
  margin-top: 20px;
  box-shadow: 0 0 10px rgba(110,224,255,0.3);
  transition: box-shadow 1.2s ease-in-out;
}

#useAICheckboxContainer:hover {
  box-shadow: 0 0 20px rgba(110,224,255,0.6);
}

@keyframes softPulse {
  0% { box-shadow: 0 0 8px rgba(110,224,255,0.3); }
  50% { box-shadow: 0 0 18px rgba(110,224,255,0.6); }
  100% { box-shadow: 0 0 8px rgba(110,224,255,0.3); }
}

#useAICheckboxContainer.glow {
  animation: softPulse 3s ease-in-out infinite;
}
    
  </style>
</head>
<body>

<!-- === Î‘Î¡Î§Î™ÎšÎ— ÎŸÎ˜ÎŸÎÎ— (Welcome Screen) === -->
<div id="welcomeScreen" style="
  position:fixed;
  inset:0;
  background:linear-gradient(180deg,#102a6d,#173b88);
  color:white;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:40px 20px 20px 20px;
  text-align:center;
  z-index:2000;
  overflow-y:auto;
  padding-bottom:80px;
">
  <img src="images/Socrates.png" alt="Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚" style="width:160px;height:160px;border-radius:50%;margin-bottom:20px;object-fit:cover;">

  <h1 style="font-size:24px;margin-bottom:10px;">AI ÎšÏÎ¹Ï„Î®Ï‚ - Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚</h1>
  <p style="font-size:15px;opacity:0.85;margin-bottom:25px;">
    ÎˆÎ½Î± Ï†Î¹Î»Î¿ÏƒÎ¿Ï†Î¹ÎºÏŒ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¿Î»Î¿Î³Î¯Î±Ï‚ Î³Î¹Î± Ï€Î±Î¹Î´Î¹Î¬ ÎºÎ±Î¹ Î¼ÎµÎ³Î¬Î»Î¿Ï…Ï‚.
  </p>

  <!-- === ÎšÎŸÎ¥ÎœÎ Î™Î‘ Î‘Î¡Î§Î™ÎšÎ—Î£ ÎŸÎ˜ÎŸÎÎ—Î£ (Main Buttons) === -->
<div class="button-container">
  <button id="startTrialsBtn">ğŸŸ¡ Î‘â€™ Î¦Î¬ÏƒÎ· â€” Î”Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯ÎµÏ‚</button>

  <button id="startBigDiscussionBtn">ğŸŸ¢ ÎœÎµÎ³Î¬Î»Î· Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·</button>

  <button id="infoButton">â„¹ï¸ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚</button>
</div>

</div>

<!-- === ÎŸÎ˜ÎŸÎÎ— Î”ÎŸÎšÎ™ÎœÎ‘Î£Î™Î©Î (Trials Screen) === -->
<div id="trialsScreen" style="
  position:fixed;
  inset:0;
  background:linear-gradient(180deg,#102a6d,#173b88);
  color:white;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:30px 20px 20px 20px;
  text-align:center;
  z-index:1900;
  overflow-y:auto;
">

  <div style="width:100%; max-width:520px;">
    <h1 style="margin:0 0 10px 0;">ğŸŸ¡ Î‘â€™ Î¦Î¬ÏƒÎ· â€” Î”Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯ÎµÏ‚</h1>
    <p style="opacity:0.85; margin:0 0 16px 0;">
      Î”Î¹Î¬Î»ÎµÎ¾Îµ Î´Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯Î±, Î´Î¹Î¬Î²Î±ÏƒÎµ Î¿Î´Î·Î³Î¯ÎµÏ‚ ÎºÎ±Î¹ Î¾ÎµÎºÎ¯Î½Î± Ï‡ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿.
    </p>

    <button id="trialsBackBtn" class="btn-secondary" style="margin-bottom:12px;">
      âŸµ Î Î¯ÏƒÏ‰ ÏƒÏ„Î·Î½ Î‘ÏÏ‡Î¹ÎºÎ®
    </button>

    <div id="trialsList" class="panel" style="text-align:left;"></div>

    <div id="trialDetails" class="panel" style="display:none; text-align:left; margin-top:14px;">
      <div style="font-weight:800; font-size:18px;" id="trialTitle">â€”</div>
      <div style="opacity:0.9; margin-top:6px;" id="trialMeta">â€”</div>

      <div style="margin-top:10px; opacity:0.9;" id="trialIntro">â€”</div>
      <div style="margin-top:10px;" id="trialInstructions">â€”</div>

      <div id="trialOptions"></div>
      <div id="trialRules"></div>

      <div style="margin-top:10px;">
        <div style="font-weight:700;">Î£Ï…Î½Î¸Î®ÎºÎ· ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±Ï‚:</div>
        <div style="opacity:0.9;" id="trialSuccess">â€”</div>
      </div>

      <div class="panel" style="margin-top:12px; text-align:center;">
        â³ Î§ÏÏŒÎ½Î¿Ï‚: <span id="trialTimer">0:00</span>
        <div class="row" style="margin-top:10px;">
          <button id="trialStartBtn" class="btn-primary">â–¶ï¸ ÎˆÎ½Î±ÏÎ¾Î·</button>
          <button id="trialStopBtn" class="btn-secondary">â¹ï¸ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="trialSuccessBtn" class="btn-secondary">âœ… Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±</button>
          <button id="trialFailBtn" class="btn-secondary">âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î±</button>
        </div>
      </div>
    </div>
  </div>
</div>
  
<!-- === ÎœÎ•Î“Î‘Î›Î— Î£Î¥Î–Î—Î¤Î—Î£Î— â€” Î•Î Î™Î›ÎŸÎ“Î— Î•ÎšÎ”ÎŸÎ£Î—Î£ (Mode Select Screen) === -->
<div id="modeSelectScreen" style="
  position:fixed;
  inset:0;
  background:rgba(10,20,60,0.95);
  color:white;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  z-index:1850;
  text-align:center;
  padding:40px 20px 20px 20px;
">
  <h1 style="margin-bottom:10px;">ğŸŸ¢ ÎœÎµÎ³Î¬Î»Î· Î£Ï…Î¶Î®Ï„Î·ÏƒÎ·</h1>
  <p style="opacity:0.9; max-width:420px;">
    Î”Î¹Î¬Î»ÎµÎ¾Îµ Î­ÎºÎ´Î¿ÏƒÎ· Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Î½Ï„Î¹Î¼Ï€Î­Î·Ï„.
  </p>

  <div style="width:100%; max-width:420px; margin-top:20px;">
    <button class="btn-secondary" id="backToWelcomeFromModeBtn">â¬…ï¸ Î Î¯ÏƒÏ‰</button>

    <button id="modeSimpleBtn" class="btn-primary" style="margin-top:10px;">
      ğŸŸ¢ Î‘Ï€Î»Î® ÎˆÎºÎ´Î¿ÏƒÎ· (ÎÏ„Î¹Î¼Ï€Î­Î·Ï„)
    </button>

    <button id="modeAdvancedBtn" class="btn-primary" style="margin-top:10px;">
      ğŸ”´ Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ· (ÎÏ„Î¹Î¼Ï€Î­Î·Ï„)
    </button>
  </div>
</div>

<!-- === Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ Î Î‘Î™Î§ÎÎ™Î”Î™ÎŸÎ¥ (Setup Screen) === -->
<div id="setupScreen" style="
  position:fixed;
  inset:0;
  background:rgba(10,20,60,0.95);
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  z-index:1000;
  text-align:center;
  padding:40px 20px 20px 20px;
">

  <h1 style="margin-bottom:20px;">ğŸ® Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</h1>

<!-- âœ¨ ÎˆÎ½Î´ÎµÎ¹Î¾Î· Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚ -->
<div id="selectedModeDisplay" style="
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 10px 14px;
  margin-bottom: 20px;
  font-weight: bold;
  font-size: 16px;
  color: #6ee0ff;
">
  âœ¨ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ·: â€”
</div>
  
  <label>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î Î±Î¹ÎºÏ„ÏÎ½:
    <select id="playerCount" style="margin-left:10px;">
      <option value="2" selected>2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
  </label>

 <div id="characterSelection" style="margin:20px 0;">

    <!-- Î•Î´Ï Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ Ï„Î± avatars Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ -->
  </div>

  <label>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î“ÏÏÏ‰Î½:
    <select id="roundCount" style="margin-left:10px;">
      <option value="1">1</option>
      <option value="2" selected>2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </label>

   <!-- ğŸ’¡ Î•Ï€Î¹Î»Î¿Î³Î® Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎšÏÎ¹Ï„Î® -->
<div id="useAICheckboxContainer" class="glow">

  <!-- ğŸ§  Î•Ï€Î¹Î»Î¿Î³Î® Î Î¿Î¹Î¿Ï‚ ÎšÏÎ¯Î½ÎµÎ¹ -->
  <div id="judgeModeContainer" style="
    background: rgba(255,255,255,0.08);
    border-radius: 15px;
    padding: 12px 16px;
    margin-top: 20px;
    box-shadow: 0 0 10px rgba(242,193,78,0.3);
  ">
    <label style="font-size:17px; display:block; margin-bottom:6px;">
      Î Î¿Î¹Î¿Ï‚ ÎºÏÎ¯Î½ÎµÎ¹;
    </label>

   <select id="judgeMode" style="width:100%; padding:8px; border-radius:10px; font-size:16px;">
  <option value="ai" selected>ğŸ¤– Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·</option>
  <option value="offline">ğŸ’» Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Rubric</option>
  <option value="manual">ğŸ‘¤ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚</option>
</select>

  <!-- ğŸ¯ Î•Ï€Î¹Î»Î¿Î³Î® Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î¼ÏŒÎ½Î¿ Ï€ÏÎ¹Î½ Ï„Î·Î½ Î­Î½Î±ÏÎ¾Î·) -->
  <div id="missionSetupContainer" style="
    background: rgba(255,255,255,0.06);
    border-radius: 15px;
    padding: 12px 16px;
    margin-top: 14px;
  ">
    <div style="font-weight:700; margin-bottom:8px;">
      ğŸ¯ Î•Ï€Î¹Î»Î¿Î³Î® Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚
    </div>

    <select id="missionSelectSetup" style="
      width:100%;
      padding:8px;
      border-radius:10px;
      font-size:16px;
    "></select>

    <div class="tiny" style="opacity:0.85; margin-top:6px;">
      Î— Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® ÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹ Î¼ÏŒÎ»Î¹Ï‚ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹.
    </div>
  </div>
</div>

  <!-- âœ… ÎÎ­Î¿ ÎµÎ½Î·Î¼ÎµÏÏ‰Ï„Î¹ÎºÏŒ Î¼Î®Î½Ï…Î¼Î± Î¼Îµ Î¿Î¼Î±Î»Î® ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· -->
<p id="aiNotice" style="
  font-size:14px;
  opacity:0;
  margin-top:8px;
  transition: opacity 0.6s ease, height 0.6s ease;
  height:0;
  overflow:hidden;
">
  ğŸ’¡ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·. Î‘Ï€Î±Î¹Ï„ÎµÎ¯ ÏƒÏÎ½Î´ÎµÏƒÎ· ÏƒÏ„Î¿ Î´Î¹Î±Î´Î¯ÎºÏ„Ï…Î¿.
</p>
</div> <!-- ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ judgeModeContainer -->
</div> <!-- ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ useAICheckboxContainer -->
  
  <button id="startGameBtn" style="
    margin-top:30px;
    background:linear-gradient(135deg,#ffd166,#ff7e5f);
    border:0;
    border-radius:25px;
    padding:12px 30px;
    font-size:18px;
    cursor:pointer;
    color:#001;
    font-weight:bold;
  ">
    ğŸš€ ÎˆÎ½Î±ÏÎ¾Î· Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
  </button>

</div>

<script>
const characters = [
  { name: "Î›Î¯Î±", color: "#ffd166", img: "images/Lia.png" },
  { name: "Î™Î¬ÏƒÏ‰Î½Î±Ï‚", color: "#06d6a0", img: "images/Jason.png" },
  { name: "Î¤Î¶Î­Î·Î¼Ï‚", color: "#118ab2", img: "images/James.png" },
  { name: "ÎœÎ¬ÏÎºÎ¿Ï‚", color: "#ef476f", img: "images/Marco.png" },
  { name: "Î†Î½Î½Î±", color: "#a29bfe", img: "images/Anna.png" },
  { name: "ÎœÎ­Î¹ Î›Î¹Î½", color: "#ffb6b9", img: "images/May_Lin.png" }
];

let selectedCharacters = []; // Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚

function renderCharacterSelection() {
  const container = document.getElementById("characterSelection");
  const status = document.createElement("div");
  status.id = "selectionStatus";
  status.style.marginTop = "10px";
  status.style.fontWeight = "bold";
  status.style.textAlign = "center";
  container.after(status);

  container.innerHTML = "";
  characters.forEach(ch => {
    const btn = document.createElement("button");
    btn.innerHTML = `
      <img src="${ch.img}" style="width:60px;height:60px;border-radius:50%;display:block;margin:0 auto 5px;">
      ${ch.name}
    `;
    btn.style.background = ch.color;
    btn.style.border = "none";
    btn.style.color = "#000";
    btn.style.padding = "10px 15px";
    btn.style.borderRadius = "15px";
    btn.style.fontWeight = "700";
    btn.style.cursor = "pointer";
    btn.style.minWidth = "80px";

    btn.dataset.id = ch.name.toLowerCase().replace(/\s+/g,"");
btn.dataset.name = ch.name;
btn.dataset.color = ch.color;
btn.dataset.img = ch.img;
btn.classList.add("character");

btn.addEventListener("click", () => toggleCharacter(ch, btn));

    container.appendChild(btn);
  });

  updateSelectionStatus();
}

function toggleCharacter(ch, btn) {
  const playerSelect = document.getElementById("playerCount");
  const count = parseInt(playerSelect.value);
  const idx = selectedCharacters.findIndex(c => c.name === ch.name);

  if (idx !== -1) {
    
    // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚, Ï„Î¿Î½ Î±Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ
    selectedCharacters.splice(idx, 1);
    btn.style.outline = "none";
    btn.classList.remove("selected");
  } else {
    // Î‘Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚
    if (selectedCharacters.length >= count) {
      alert(`ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹Ï‚ Î­Ï‰Ï‚ ${count} Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.`);
      return; // ÏƒÏ„Î±Î¼Î±Ï„Î¬Î¼Îµ ÎµÎ´Ï
    }
    selectedCharacters.push(ch);
    btn.style.outline = "4px solid white";
    btn.classList.add("selected");
  }

  updateSelectionStatus();
}

function updateSelectionStatus() {
  const count = parseInt(document.getElementById("playerCount").value);
  const status = document.getElementById("selectionStatus");
  status.textContent = count === 1
  ? `ÎˆÏ‡ÎµÎ¹Ï‚ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ${selectedCharacters.length} Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ±.`
  : `ÎˆÏ‡ÎµÎ¹Ï‚ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ ${selectedCharacters.length} Î±Ï€ÏŒ ${count} Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.`;


const startBtn = document.getElementById("startGameBtn");
startBtn.disabled = selectedCharacters.length < count;
startBtn.style.opacity = startBtn.disabled ? "0.5" : "1";
}
renderCharacterSelection();

document.getElementById("playerCount").addEventListener("change", () => {
  // Î‘Î½ Î¼ÎµÎ¹Ï‰Î¸ÎµÎ¯ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€Î±Î¹ÎºÏ„ÏÎ½ ÎºÎ±Î¹ Î­Ï‡Î¿Ï…Î¼Îµ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚, Î±Ï†Î±Î¯ÏÎµÏƒÎ­ Ï„Î¿Ï…Ï‚
  const count = parseInt(document.getElementById("playerCount").value);
  if (selectedCharacters.length > count) {
    selectedCharacters = selectedCharacters.slice(0, count);
  }
  // Î‘Ï†Î±Î¯ÏÎµÏƒÎµ Ï„Î± outlines Î±Ï€ÏŒ ÏŒÏƒÎ¿Ï…Ï‚ â€œÎºÏŒÏ€Î·ÎºÎ±Î½â€
  document.querySelectorAll(".character").forEach(btn => {
    const name = btn.textContent.trim();
    if (!selectedCharacters.find(c => c.name === name)) {
      btn.style.outline = "none";
      btn.classList.remove("selected");
    }
  });
  updateSelectionStatus();
  // âœ… Î‘Î½ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€Î±Î¹ÎºÏ„ÏÎ½ ÎµÎ¯Î½Î±Î¹ 6, ÎµÏ€Î¯Î»ÎµÎ¾Îµ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚
if (count === 6) {
  selectedCharacters = [...characters];
  document.querySelectorAll(".character").forEach(btn => {
    btn.classList.add("selected");
    btn.style.outline = "4px solid white";
  });
  updateSelectionStatus();
}
  // ğŸš« Î‘Î½ Î¼ÎµÎ¹Ï‰Î¸ÎµÎ¯ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ Ï€Î±Î¹ÎºÏ„ÏÎ½ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ 6, Î±Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½
if (count < 6) {
  selectedCharacters = [];
  document.querySelectorAll(".character").forEach(btn => {
    btn.classList.remove("selected");
    btn.style.outline = "none";
  });
  updateSelectionStatus();
}
});

</script>

 <div class="app" id="appScreen" style="display:none;">
  <h1 id="missionTitle">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</h1>
  <h2 id="missionQuestion">â€”</h2>

<div class="panel" id="activePlayerBar">
  <div style="display:flex; align-items:center; gap:10px; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:10px;">
      <div id="activeAvatar" style="width:36px;height:36px;border-radius:50%;background:#cfe0ff;color:#0e2a66;display:flex;align-items:center;justify-content:center;font-weight:700;">
        Î›
      </div>
      <div>
        <div style="font-weight:700;">Î•Î½ÎµÏÎ³ÏŒÏ‚ Î Î±Î¯ÎºÏ„Î·Ï‚: <span id="activePlayerName">â€”</span></div>
        <div class="tiny">Î“ÏÏÎ¿Ï‚: <span id="roundLabel">1</span>/<span id="roundTotal">2</span></div>
      </div>
    </div>

<div style="display:flex; gap:10px; align-items:center;">
  <div style="display:flex; flex-direction:column; gap:6px;">
    <button class="btn-secondary" id="bonusBtn" title="ÎšÎ¬ÏÏ„Î± +30â€³" style="min-width:100px;">+30â€³</button>
    <button class="btn-secondary" id="exampleBtn" style="min-width:100px;" onclick="showExample()">ğŸ² Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±</button>
  </div>
  
    
  </div>
</div>

  <div class="row">
   <select id="missionSelect" style="display:none;"></select>
    <select id="langSelect" title="Î“Î»ÏÏƒÏƒÎ± Î‘ÎºÏÏŒÎ±ÏƒÎ·Ï‚">
      <option value="el-GR" selected>Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
      <option value="en-US">English</option>
    </select>
  </div>

  <textarea id="transcript" placeholder="ÎœÎ¯Î»Î± ÏƒÏ„Î¿ Î¼Î¹ÎºÏÏŒÏ†Ï‰Î½Î¿ Î® Î³ÏÎ¬ÏˆÎµ ÎµÎ´Ï Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Ï„Î¿Ï… Ï€Î±Î¯ÎºÏ„Î·â€¦"></textarea>
<p id="philosopherHint" style="
  font-size:14px;
  color:#cfe0ff;
  opacity:0.9;
  margin-top:4px;
  font-style:italic;
">
ğŸ’¬ ÎÎµÎºÎ¯Î½Î± Î±Î½Î±Ï†Î­ÏÎ¿Î½Ï„Î±Ï‚ Ï„Î¿Î½ Ï†Î¹Î»ÏŒÏƒÎ¿Ï†ÏŒ ÏƒÎ¿Ï… ÎºÎ±Î¹ Ï„Î· ÏÎ®ÏƒÎ· Ï„Î¿Ï….<br>
Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±: Â«ÎŸ Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚ ÎµÎ¯Ï€Îµ Ï€Ï‰Ï‚ Î· Ï†Î¹Î»Î¯Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¯Î± ÏˆÏ…Ï‡Î® ÏƒÎµ Î´ÏÎ¿ ÏƒÏÎ¼Î±Ï„Î±â€¦Â»
</p>

  <button class="btn-primary" id="listenBtn">â–¶ï¸ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î±ÎºÎ¿ÏÎµÎ¹/Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹</button>
  <button class="btn-secondary" id="scoreBtn">âš–ï¸ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</button>

    <!-- ğŸ§ Î†ÎºÎ¿Ï… Ï„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î· -->
    <button class="btn-secondary" id="speakBtn">ğŸ”Š Î†ÎºÎ¿Ï… Ï„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î·</button>

<p id="aiModeIndicator" style="
  text-align:center;
  font-size:14px;
  color:#6ee0ff;
  margin-top:-5px;
  margin-bottom:10px;
  opacity:0.85;
">
  ğŸ¤– ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·
</p>
  
<div class="panel" id="timerPanel">
  â³ Î§ÏÏŒÎ½Î¿Ï‚: <span id="timer">1:30</span>
  <div id="timeBarContainer">
    <div id="timeBar"></div>
  </div>
</div>

<p id="judgeModeIndicator" style="
  text-align:center;
  font-size:13px;
  color:#ffd166;
  margin-top:-6px;
  margin-bottom:10px;
  opacity:0.85;
">
  Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: ğŸ¤– AI ÎšÏÎ¹Ï„Î®Ï‚ (API)
</p>
    
<!-- ğŸ’¬ Î£Ï‡ÏŒÎ»Î¹Î¿ Î£Ï‰ÎºÏÎ¬Ï„Î· -->
<div class="panel" id="socraticPanel">
  <div class="socrates-header">ğŸ’¬ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÏ‡Î¿Î»Î¹Î¬Î¶ÎµÎ¹:</div>
  <div id="socraticComment" class="socrates-comment">â€”</div>
</div>

<!-- âš–ï¸ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚ -->
<div class="panel" id="criteriaPanel">
  <div class="criteria-header">âš–ï¸ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚</div>
  <ul id="criteriaList"></ul>
</div>

<!-- ğŸŒŸ Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î£ÎºÎ¿Ï -->
<div id="scorePanel">
  <div class="score-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</div>
  <div class="score-value" id="totalScore">â€”/8</div>
</div>

  <!-- âœ… ÎšÎ¿Ï…Î¼Ï€Î¯ Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î Î±Î¯ÎºÏ„Î·Ï‚ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± -->
<div style="display:flex; justify-content:center; margin-top:20px;">
  <button class="btn-secondary" id="nextPlayerBtn" style="
    min-width:200px;
    font-size:18px;
    padding:10px 0;
    border-radius:15px;
    font-weight:bold;
    color:#002140;
  ">
    âŸ¶ Î•Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Î Î±Î¯ÎºÏ„Î·Ï‚
  </button>
</div>

<script>

/* ---------- Timer (globals first) ---------- */
let timerInterval = null;
let isTimerRunning = false;
let remainingTime = 90;
let isPaused = false;
let useAI = false;  // âœ… Î•Î»Î­Î³Ï‡ÎµÎ¹ Î±Î½ Î¿ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î¸Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î¼Îµ Î¤Î
let judgeMode = "ai"; // ai | offline | manual

  /* ---------- ÎˆÎºÎ´Î¿ÏƒÎ· Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï ---------- */
const SOCRATES_VERSION = "1.3-stable"; // ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÎ¹Ï‚ ÎµÎ´Ï ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î±Î»Î»Î±Î³Î­Ï‚

  
/* ---------- Missions ---------- */
const missions = [
  {id:"M-001",title:"Î”Î¯ÎºÎ±Î¹Î¿",question:"Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Î´Î¯ÎºÎ±Î¹Î¿;"},
  {id:"M-002",title:"Î¦Î¹Î»Î¯Î±",question:"Î¤Î¹ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ Î½Î± ÎµÎ¯Î¼Î±Î¹ Ï†Î¯Î»Î¿Ï‚;"},
  {id:"M-003",title:"Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±",question:"Î“Î¹Î±Ï„Î¯ Î´ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± Ï„Î± Î­Ï‡Ï‰ ÏŒÎ»Î±;"},
  {id:"M-004",title:"Î•Ï…Î³Î½Ï‰Î¼Î¿ÏƒÏÎ½Î·",question:"Î“Î¹Î±Ï„Î¯ Î»Î­Î¼Îµ \"ÎµÏ…Ï‡Î±ÏÎ¹ÏƒÏ„Ï\";"},
  {id:"M-005",title:"Î‘Î»Î®Î¸ÎµÎ¹Î±",question:"Î ÏÎ­Ï€ÎµÎ¹ Ï€Î¬Î½Ï„Î± Î½Î± Î»Î­Î¼Îµ Ï„Î·Î½ Î±Î»Î®Î¸ÎµÎ¹Î±;"},
  {id:"M-006",title:"Î˜Î¬ÏÏÎ¿Ï‚",question:"Î¤Î¹ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ Î½Î± ÎµÎ¯ÏƒÎ±Î¹ Î³ÎµÎ½Î½Î±Î¯Î¿Ï‚;"},
  {id:"M-007",title:"Î‘Ï€Î¿Î´Î¿Ï‡Î® Î‰Ï„Ï„Î±Ï‚",question:"Î•Î¯Î½Î±Î¹ Î´Î¯ÎºÎ±Î¹Î¿ Î½Î± Ï‡Î¬Î½Ï‰;"},
  {id:"M-008",title:"Î‘Î³Î¬Ï€Î·",question:"Î ÏÏ‚ Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î±Î³Î±Ï€Î¬Î¼Îµ;"},
  {id:"M-009",title:"ÎšÎ±Î½ÏŒÎ½ÎµÏ‚",question:"Î“Î¹Î±Ï„Î¯ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Î½ÏŒÎ½ÎµÏ‚;"},
  {id:"M-010",title:"Î•Ï…Ï„Ï…Ï‡Î¯Î±",question:"Î¤Î¹ ÏƒÎµ ÎºÎ¬Î½ÎµÎ¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ Ï‡Î±ÏÎ¿ÏÎ¼ÎµÎ½Î¿;"},
  {id:"M-011",title:"Î•Î»Ï€Î¯Î´Î±/ÎŒÎ½ÎµÎ¹ÏÎ±",question:"Î“Î¹Î±Ï„Î¯ ÎµÎ¯Î½Î±Î¹ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î½Î± Î¿Î½ÎµÎ¹ÏÎµÏÎµÏƒÎ±Î¹;"},
  {id:"M-012",title:"Î ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±",question:"Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Î±Î»Î·Î¸Î¹Î½ÏŒ;"},
  {id:"M-013",title:"Î£ÎµÎ²Î±ÏƒÎ¼ÏŒÏ‚",question:"Î ÏÏ‚ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹Ï‚ ÏƒÎµÎ²Î±ÏƒÎ¼ÏŒ;"},
  {id:"M-014",title:"Î‘Ï…Ï„Î¿ÏƒÏ…Î½ÎµÎ¯Î´Î·ÏƒÎ·",question:"Î ÏÏ‚ Î¾Î­ÏÏ‰ Ï€Î¿Î¹Î¿Ï‚ ÎµÎ¯Î¼Î±Î¹;"},
  {id:"M-015",title:"Î–Î®Î»ÎµÎ¹Î±",question:"Î•Î¯Î½Î±Î¹ ÎºÎ±ÎºÏŒ Î½Î± Î¶Î·Î»ÎµÏÏ‰;"},
  {id:"M-016",title:"ÎšÎ±Î»Î¿ÏƒÏÎ½Î·",question:"Î¤Î¹ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ Î½Î± ÎµÎ¯Î¼Î±Î¹ ÎºÎ±Î»ÏŒÏ‚;"},
  {id:"M-017",title:"Î•Î»ÎµÏ…Î¸ÎµÏÎ¯Î±",question:"Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Î· Î•Î»ÎµÏ…Î¸ÎµÏÎ¯Î±;"},
  {id:"M-018",title:"Î¨Ï…Ï‡Î®",question:"Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î¨Ï…Ï‡Î®;"},
  {id:"M-019",title:"ÎÏŒÎ·Î¼Î± Ï„Î·Ï‚ Î–Ï‰Î®Ï‚",question:"ÎˆÏ‡ÎµÎ¹ Î½ÏŒÎ·Î¼Î± Î· Î–Ï‰Î®;"},
  {id:"M-020",title:"Î£Ï‰ÏƒÏ„ÏŒ-Î›Î¬Î¸Î¿Ï‚",question:"Î Î¿Î¹Î¿Ï‚ Î±Ï€Î¿Ï†Î±ÏƒÎ¯Î¶ÎµÎ¹ Ï„Î¹ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ;"},
  {id:"M-021",title:"Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·",question:"Î ÏŒÏƒÎ· Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î· ÎµÎ¯Î½Î±Î¹ Î±ÏÎºÎµÏ„Î®;"}
];

/* ---------- Î•Î¹ÎºÏŒÎ½ÎµÏ‚ Î¦Î¹Î»Î¿ÏƒÏŒÏ†Ï‰Î½ ---------- */
const philosopherImages = {
  "Î Î»Î¬Ï„Ï‰Î½": "images/philosophers/Plato.png",
  "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚": "images/philosophers/Aristotle.png",
  "Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚": "images/philosophers/Socrates.png",
  "Î•Ï€Î¯ÎºÎ¿Ï…ÏÎ¿Ï‚": "images/philosophers/Epicurus.png",
  "Î•Ï€Î¯ÎºÏ„Î·Ï„Î¿Ï‚": "images/philosophers/Epictetus.png"
};
   
/* ---------- Î¡Î®ÏƒÎµÎ¹Ï‚ Î±Î½Î¬ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ---------- */
const quotesByMission = {
  "M-001": [
    { author: "Î Î»Î¬Ï„Ï‰Î½", quote: "ÎŸ Î´Î¯ÎºÎ±Î¹Î¿Ï‚ Î¬Î½Î¸ÏÏ‰Ï€Î¿Ï‚ Î´ÎµÎ½ Î²Î»Î¬Ï€Ï„ÎµÎ¹ Ï€Î¿Ï„Î­ ÎºÎ±Î½Î­Î½Î±Î½. (Î Î¿Î»Î¹Ï„ÎµÎ¯Î±)" },
    { author: "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚", quote: "Î¤Î¿ Î´Î¯ÎºÎ±Î¹Î¿ ÎµÎ¯Î½Î±Î¹ Î· Î±ÏÏ‡Î® Ï„Î·Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ Î±ÏÎµÏ„Î®Ï‚. (Î—Î¸Î¹ÎºÎ¬ ÎÎ¹ÎºÎ¿Î¼Î¬Ï‡ÎµÎ¹Î±)" }
  ],
  "M-002": [
    { author: "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚", quote: "Î— Ï†Î¹Î»Î¯Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¯Î± ÏˆÏ…Ï‡Î® ÏƒÎµ Î´ÏÎ¿ ÏƒÏÎ¼Î±Ï„Î±." },
    { author: "Î•Ï€Î¯ÎºÎ¿Ï…ÏÎ¿Ï‚", quote: "Î‘Ï€ÏŒ ÏŒÎ»Î± ÏŒÏƒÎ± Î· ÏƒÎ¿Ï†Î¯Î± Î¼Î¬Ï‚ Ï‡Î±ÏÎ¯Î¶ÎµÎ¹ Î³Î¹Î± Ï„Î·Î½ ÎµÏ…Ï„Ï…Ï‡Î¯Î±, Ï„Î¿ Ï€Î¿Î»Ï…Ï„Î¹Î¼ÏŒÏ„ÎµÏÎ¿ ÎµÎ¯Î½Î±Î¹ Î· Ï†Î¹Î»Î¯Î±." }
  ],
  "M-005": [
    { author: "Î Î»Î¬Ï„Ï‰Î½", quote: "Î— Î±Î»Î®Î¸ÎµÎ¹Î± ÎµÎ¯Î½Î±Î¹ Î¿ Î®Î»Î¹Î¿Ï‚ Ï„Î¿Ï… Î½Î¿Ï…." },
    { author: "Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚", quote: "ÎˆÎ½Î± Î¼ÏŒÎ½Î¿ Î¾Î­ÏÏ‰: ÏŒÏ„Î¹ Î´ÎµÎ½ Î¾Î­ÏÏ‰ Ï„Î¯Ï€Î¿Ï„Î±. (Î‘Ï€Î¿Î»Î¿Î³Î¯Î±)" }
  ],
  "M-006": [
    { author: "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚", quote: "Î— Î±Î½Î´ÏÎµÎ¯Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¼Î­ÏƒÎ¿ Î±Î½Î¬Î¼ÎµÏƒÎ± ÏƒÏ„Î¿Î½ Ï†ÏŒÎ²Î¿ ÎºÎ±Î¹ Ï„Î·Î½ Ï„ÏŒÎ»Î¼Î·." }
  ],
  "M-010": [
    { author: "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚", quote: "Î— ÎµÏ…Ï„Ï…Ï‡Î¯Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Ï„ÎµÎ»Î¹ÎºÏŒ Î±Î³Î±Î¸ÏŒ ÏƒÏ„Î¿ Î¿Ï€Î¿Î¯Î¿ Î±Ï€Î¿Î²Î»Î­Ï€Î¿Ï…Î½ ÏŒÎ»ÎµÏ‚ Î¿Î¹ Ï€ÏÎ¬Î¾ÎµÎ¹Ï‚ Î¼Î±Ï‚." },
    { author: "Î•Ï€Î¯ÎºÎ¿Ï…ÏÎ¿Ï‚", quote: "Î— ÎµÏ…Ï„Ï…Ï‡Î¯Î± Î´ÎµÎ½ Î­ÏÏ‡ÎµÏ„Î±Î¹ Î¼Îµ Ï„Î± Ï€Î»Î¿ÏÏ„Î·, Î±Î»Î»Î¬ Î¼Îµ Ï„Î· Î³Î±Î»Î®Î½Î· Ï„Î·Ï‚ ÏˆÏ…Ï‡Î®Ï‚." }
  ],
  "M-017": [
    { author: "Î•Ï€Î¯ÎºÏ„Î·Ï„Î¿Ï‚", quote: "Î•Î»ÎµÏÎ¸ÎµÏÎ¿Ï‚ ÎµÎ¯Î½Î±Î¹ ÏŒÏ€Î¿Î¹Î¿Ï‚ Î´ÎµÎ½ ÎµÎ¾Î±ÏÏ„Î¬Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î± Ï€Î¬Î¸Î· Ï„Î¿Ï…." },
    { author: "Î Î»Î¬Ï„Ï‰Î½", quote: "Î— ÎµÎ»ÎµÏ…Î¸ÎµÏÎ¯Î± ÎµÎ¯Î½Î±Î¹ Î· Ï„Î¬Î¾Î· Ï„Î·Ï‚ ÏˆÏ…Ï‡Î®Ï‚ Ï€Î¿Ï… Î³Î½Ï‰ÏÎ¯Î¶ÎµÎ¹ Ï„Î¿ Î´Î¯ÎºÎ±Î¹Î¿." }
  ],
  "M-019": [
    { author: "Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚", quote: "Î¤Î¿ Î½ÏŒÎ·Î¼Î± Ï„Î·Ï‚ Î¶Ï‰Î®Ï‚ ÎµÎ¯Î½Î±Î¹ Î½Î± Î²ÏÎµÎ¹Ï‚ Ï„Î¿Î½ ÏƒÎºÎ¿Ï€ÏŒ ÏƒÎ¿Ï… ÎºÎ±Î¹ Î½Î± Ï„Î¿Ï… Î±Ï†Î¹ÎµÏÏ‰Î¸ÎµÎ¯Ï‚." },
    { author: "Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚", quote: "ÎœÎ· Î¶ÎµÎ¹Ï‚ Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± ÎµÎ¾ÎµÏ„Î¬Î¶ÎµÎ¹Ï‚ Ï„Î· Î¶Ï‰Î® ÏƒÎ¿Ï…. (Î‘Ï€Î¿Î»Î¿Î³Î¯Î±)" }
  ]
};

/* ---------- (Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿) Î Î±Î»Î±Î¹ÏŒ RUBRIC ---------- 
const RUBRIC = {
  order: ["Î˜Î­ÏƒÎ·", "Î¤ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·", "Î£Ï…Î½Î¬Ï†ÎµÎ¹Î±", "Î£Î±Ï†Î®Î½ÎµÎ¹Î±", "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·"],
  weights: {
    "Î˜Î­ÏƒÎ·":       { min: 0, max: 2 },
    "Î¤ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·": { min: 0, max: 2 },
    "Î£Ï…Î½Î¬Ï†ÎµÎ¹Î±":   { min: 0, max: 2 },
    "Î£Î±Ï†Î®Î½ÎµÎ¹Î±":   { min: 0, max: 2 },
    "Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·":  { min: 0, max: 2 }
  },
  maxPerRound: 8
};
---------- Î¤Î•Î›ÎŸÎ£ Î Î‘Î›Î‘Î™ÎŸÎ¥ RUBRIC ---------- */

/* ---------- Manual Rubric (Ï†Î¿ÏÏ„ÏÎ½ÎµÏ„Î±Î¹ Î±Ï€ÏŒ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿) ---------- */
let MANUAL_RUBRIC = { criteria: [] };

async function loadRubric() {
  try {
    const response = await fetch("data/rubricWeights.json");
    if (!response.ok) throw new Error("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ rubricWeights.json");
    const data = await response.json();
    MANUAL_RUBRIC = data;
    console.log("ğŸ“˜ Rubric Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚:", MANUAL_RUBRIC);
  } catch (err) {
    console.error("âš ï¸ Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· rubricWeights.json:", err);
  }
}

function getActiveManualCriteria(gameMode, currentRound) {
  const isFirstRound = currentRound === 1;
  const isSimple = (gameMode || "simple") === "simple";

  // ğŸ§  ÎœÎ½Î®Î¼Î· Ï€Î±Î¯ÎºÏ„Î·: Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¾Î±Î½Î±Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Î³ÏÏÎ¿Ï…Ï‚
  const activePlayer = game.players[game.activeIndex].name;
  const memory = playerPositions[activePlayer] || {};

  return MANUAL_RUBRIC.criteria.filter(c => {
    const roundOK = isFirstRound ? c.rounds.first : c.rounds.later;
    const modeOK  = isSimple ? c.simple : c.advanced;
    if (!(roundOK && modeOK)) return false;

    // âŒ ÎœÎ·Î½ Î¾Î±Î½Î±ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹Ï‚ ÎºÏÎ¹Ï„Î®ÏÎ¹Î± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î®Î´Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ Î³Î¹Î± Ï„Î¿Î½ Ï€Î±Î¯ÎºÏ„Î·
    // âœ… Î”ÎµÎ½ Ï„Î± Î±Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±.
// Î˜Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½, Î±Î»Î»Î¬ Î¸Î± Î³Î¯Î½Î¿Ï…Î½ disabled Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ getManualScore().

    return true;
  });
}

/* ---------- Game state ---------- */
const game = {
  players: [
    { id: 'p1', name: 'Î›Î¯Î±', color: '#ffd166', bonusLeft: 1 },
    { id: 'p2', name: 'Î™Î¬ÏƒÏ‰Î½Î±Ï‚', color: '#06d6a0', bonusLeft: 1 }
  ],
  currentRound: 1,
  totalRounds: 2,
  activeIndex: 0,
  baseTimeSec: 90,
   scores: {}   // âœ… ÎµÎ´Ï Î´Î·Î»ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿Î½ Ï‡ÏÏÎ¿ ÏŒÏ€Î¿Ï… Î¸Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Î¿Î¹ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚
};

  /* ---------- ÎœÎ½Î®Î¼Î· Î˜Î­ÏƒÎµÏ‰Î½ Î¦Î¹Î»Î¿ÏƒÏŒÏ†Ï‰Î½ ---------- */
// Î‘Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï€Î±Î¯ÎºÏ„Î· Ï„Î· Ï†Î¹Î»Î¿ÏƒÎ¿Ï†Î¹ÎºÎ® Ï„Î¿Ï… Î¸Î­ÏƒÎ· (Î¼ÏŒÎ½Î¿ Ï„Î·Î½ Ï€ÏÏÏ„Î· Ï†Î¿ÏÎ¬)
const playerPositions = {};
  
function renderActivePlayer() {
  const p = game.players[game.activeIndex];
  document.getElementById('activePlayerName').textContent = p.name;

  // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ Ï†Î¹Î»Î¿ÏƒÏŒÏ†Î¿Ï… Î® fallback Î³ÏÎ¬Î¼Î¼Î±
const avatar = document.getElementById('activeAvatar');
if (p.img) {
  avatar.innerHTML = `
    <img src="${p.img}" alt="${p.name}" 
      style="width:100%;height:100%;border-radius:50%;object-fit:cover;
      border:3px solid ${p.color || '#6ee0ff'};box-shadow:0 0 10px ${p.color || '#6ee0ff'};">
  `;
} else {
  avatar.textContent = p.name[0] || 'Î ';
  avatar.style.color = "#0e2a66";
}

  document.getElementById('activeAvatar').style.background = p.color || '#cfe0ff';
  document.getElementById('roundLabel').textContent = game.currentRound;
  document.getElementById('roundTotal').textContent = game.totalRounds;
  const bonusBtn = document.getElementById('bonusBtn');
  bonusBtn.disabled = p.bonusLeft <= 0;
}

/* ---------- Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ½Î´ÎµÎ¯Î¾ÎµÏ‰Î½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎšÏÎ¹Ï„Î® ---------- */
function updateJudgeModeIndicator(mode) {
  const topText = document.getElementById("aiModeIndicator");
  const bottomText = document.getElementById("judgeModeIndicator");

  if (!topText || !bottomText) return;

  if (mode === "ai") {
    topText.innerHTML = "ğŸ§  ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÏ…Î»Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ Ï„Î· Î²Î¿Î®Î¸ÎµÎ¹Î± Î¤ÎµÏ‡Î½Î·Ï„Î®Ï‚ ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î·Ï‚.";
    bottomText.innerHTML = "Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: ğŸ¤– AI ÎšÏÎ¹Ï„Î®Ï‚ (API)";
  }
  else if (mode === "offline") {
    topText.innerHTML = "ğŸ’» ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î±Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯ Î²Î¬ÏƒÎµÎ¹ Ï„Î¿Ï… rubric Ï„Î¿Ï… Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï.";
    bottomText.innerHTML = "Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: ğŸ’» Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ ÎšÏÎ¹Ï„Î®Ï‚";
  }
  else if (mode === "manual") {
    topText.innerHTML = "âœï¸ Î— Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î³Î¯Î½ÎµÏ„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± â€” Î²Î±Î¸Î¼Î¿Î»Î¿Î³ÎµÎ¯ Î¿ Ï€Î±Î¯ÎºÏ„Î·Ï‚ Ï€Î¿Ï… Î­Ï‡ÎµÏ„Îµ ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹!";
    bottomText.innerHTML = "Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: âœï¸ Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·";
  }
  else {
    topText.innerHTML = "âš–ï¸ Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏŒÏ€Î¿ Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚.";
    bottomText.innerHTML = "â€”";
  }

  console.log(`âš™ï¸ Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎºÏÎ¹Ï„Î® ÏƒÎµ: ${mode}`);
}

function loadMissions(selectId = "missionSelectSetup", autoRender = false){
  const sel = document.getElementById(selectId);
  if (!sel) return;

  sel.innerHTML = "";
  missions.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.id} â€” ${m.title}`;
    sel.appendChild(opt);
  });

  // Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ preview (ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ OFF ÏƒÏ„Î¿ setup)
  if (autoRender && missions[0]) {
    renderMission(missions[0].id);
  }
}
  
// ğŸ”’ ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ Î±Ï†Î¿Ï Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹
const sel = document.getElementById("missionSelect");
if (sel) sel.disabled = true;

  /* ---------- Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¡Î®ÏƒÎµÏ‰Î½ Î¦Î¹Î»Î¿ÏƒÏŒÏ†Ï‰Î½ Î±Ï€ÏŒ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ---------- */
async function loadPhilosopherPositions(missionId) {
  try {
   const base = window.location.origin;
const response = await fetch(`${base}/data/philosopherPositions.json`);
    console.log("ğŸ” Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ server:", response.url, response.status);
    const allData = await response.json();

    if (!allData[missionId]) {
      console.warn(`Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ${missionId}`);
      return [];
    }

    const philosophers = Object.entries(allData[missionId]).map(([name, quote]) => ({
      name,
      quote
    }));

    console.log("ğŸ“œ Î¡Î®ÏƒÎµÎ¹Ï‚ Î¦Î¹Î»Î¿ÏƒÏŒÏ†Ï‰Î½:", philosophers);
    return philosophers;

  } catch (err) {
    console.error("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· philosopherPositions.json:", err);
    return [];
  }
}

/* ---------- Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î•ÎºÏ†ÏÎ¬ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ ÎœÎ·Î½Ï…Î¼Î¬Ï„Ï‰Î½ Î‘Î½Î±Ï„ÏÎ¿Ï†Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚ ---------- */
let argumentPatterns = {};
let feedbackMessages = {};

async function loadArgumentPatterns() {
  try {
    const response = await fetch("https://ai-kritis-demo.vercel.app/data/argumentPatterns.json");
    argumentPatterns = await response.json();
    console.log("ğŸ§  Î•ÎºÏ†ÏÎ¬ÏƒÎµÎ¹Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î¬Ï„Ï‰Î½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½:", argumentPatterns);
  } catch (err) {
    console.error("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· argumentPatterns.json:", err);
  }
}

async function loadFeedbackMessages() {
  try {
    const response = await fetch("https://ai-kritis-demo.vercel.app/data/feedbackMessages.json");
    feedbackMessages = await response.json();
    console.log("ğŸ’¬ ÎœÎ·Î½ÏÎ¼Î±Ï„Î± Î±Î½Î±Ï„ÏÎ¿Ï†Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½:", feedbackMessages);
  } catch (err) {
    console.error("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· feedbackMessages.json:", err);
  }
}

/* Î•ÎºÏ„ÎµÎ»Î¿ÏÎ¼Îµ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ ÏŒÏ„Î±Î½ Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î· ÏƒÎµÎ»Î¯Î´Î± */
window.addEventListener("load", async () => {
  await Promise.all([
    loadArgumentPatterns(),
    loadFeedbackMessages()
  ]);

  // ğŸ¯ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î»Î¯ÏƒÏ„Î±Ï‚ Î±Ï€Î¿ÏƒÏ„Î¿Î»ÏÎ½ ÏƒÏ„Î¿ setup
  loadMissions("missionSelectSetup", false);
});
  
function renderMission(id){
const m = missions.find(x=>x.id===id);
const missionNum = parseInt(String(m.id || "").match(/\d+/)?.[0] || "0", 10) || "";
document.getElementById("missionTitle").textContent = `Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ${missionNum}: ${m.title}`;
document.getElementById("missionQuestion").textContent = `${m.question}`;
  // ğŸ“– Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏÎ®ÏƒÎµÏ‰Î½ Ï†Î¹Î»Î¿ÏƒÏŒÏ†Ï‰Î½ Î³Î¹Î± Ï„Î· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®
  loadPhilosopherPositions(id).then(data => {
    if (data.length > 0) {
      const first = data[0];
      document.getElementById("philosopherHint").innerHTML =
        `ğŸ’¬ ÎÎµÎºÎ¯Î½Î± Î±Î½Î±Ï†Î­ÏÎ¿Î½Ï„Î±Ï‚ Ï„Î¿Î½ Ï†Î¹Î»ÏŒÏƒÎ¿Ï†ÏŒ ÏƒÎ¿Ï… ÎºÎ±Î¹ Ï„Î· ÏÎ®ÏƒÎ· Ï„Î¿Ï….<br>Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±: Â«${first.name} ÎµÎ¯Ï€Îµ: ${first.quote}Â»`;
    }
  });
 
  document.getElementById("missionSelect").value = id;
}

/* ---------- ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î±Ï‚ ÎµÎºÏ†ÏÎ¬ÏƒÎµÏ‰Î½ (pattern detection) ---------- */
function checkPatterns(answerText, patterns) {
  const text = answerText.toLowerCase();
  const found = {};

  for (const [category, expressions] of Object.entries(patterns)) {
    found[category] = expressions.some(expr => text.includes(expr));
  }

  return found;
}

/* ---------- Î¤Ï…Ï‡Î±Î¯Î± Î£Ï‡ÏŒÎ»Î¹Î± Î£Ï‰ÎºÏÎ¬Ï„Î· ---------- */
const socratesComments = [
  "Î— ÏƒÎ¹Ï‰Ï€Î® ÎµÎ¯Î½Î±Î¹ ÎºÎ¹ Î±Ï…Ï„Î® Î¼Î¹Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.",
  "ÎšÎ±Î»Î® ÏƒÎºÎ­ÏˆÎ·, Î±Î»Î»Î¬ Î¼Î®Ï€Ï‰Ï‚ Î­Ï‡ÎµÎ¹ ÎºÎ¹ Î¬Î»Î»Î· ÏŒÏˆÎ·;",
  "ÎŸ Î´Î¹Î¬Î»Î¿Î³Î¿Ï‚ Î±Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î¿Î½ Î´ÏÏŒÎ¼Î¿ Ï„Î·Ï‚ ÏƒÎ¿Ï†Î¯Î±Ï‚.",
  "Î— Î±Î»Î®Î¸ÎµÎ¹Î± Î³ÎµÎ½Î½Î¹Î­Ï„Î±Î¹ Î¼Î­ÏƒÎ± Î±Ï€ÏŒ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚.",
  "ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Ï‡Î±Î¼Î¿Î³ÎµÎ»Î¬ â€“ Ï€ÏÎ¿Ï‡ÏÏÎ± Î­Ï„ÏƒÎ¹!",
  "ÎœÎµÏÎ¹ÎºÎ­Ï‚ Ï†Î¿ÏÎ­Ï‚, Î· Î³Î½ÏÏƒÎ· Î¾ÎµÎºÎ¹Î½Î¬ Î±Ï€ÏŒ Ï„Î·Î½ Î±Ï€Î¿ÏÎ¯Î±.",
  "Î£ÎºÎ­ÏˆÎ¿Ï… Î¾Î±Î½Î¬: Ï€Î¿Î¹Î¿ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î³Î¹Î±Ï„Î¯ Ï€Î¯ÏƒÏ‰ Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ;",
  "ÎšÎ¬Î¸Îµ Î¹Î´Î­Î± Î±Î¾Î¯Î¶ÎµÎ¹ Î½Î± Î±ÎºÎ¿Ï…ÏƒÏ„ÎµÎ¯."
];
  
/* ---------- Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Popup Î£Ï‰ÎºÏÎ¬Ï„Î· ---------- */
function showSocratesPopup() {
  const random = Math.floor(Math.random() * socratesComments.length);
  const message = socratesComments[random];
  const popup = document.getElementById("socratesPopup");
  const text = document.getElementById("socratesPopupText");

  text.textContent = message;
  popup.style.display = "block";

  // âœ¨ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎºÎ»Î¬ÏƒÎµÏ‰Î½ Î³Î¹Î± ÎµÏ†Î­ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ & Î»Î¬Î¼ÏˆÎ·Ï‚
  popup.classList.add("show", "glow");

  // ÎœÎµÏ„Î¬ Î±Ï€ÏŒ 3 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± fade out
  setTimeout(() => {
    popup.classList.remove("glow");
    popup.style.opacity = 0;
    popup.style.transform = "translateY(20px)";
    setTimeout(() => {
      popup.style.display = "none";
      popup.classList.remove("show");
    }, 1000);
  }, 3000);
}

/* ---------- Advance turn & round ---------- */
function advanceTurn() {
  const isLastPlayer = game.activeIndex === game.players.length - 1;
  const isLastRound = game.currentRound === game.totalRounds;

  // âœ… Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Ï€Î±Î¯ÎºÏ„Î·Ï‚ Ï„Î¿Ï… Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï… Î³ÏÏÎ¿Ï…,
  // Ï€ÏÏÏ„Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Ï…Î¼Îµ ÏŒ,Ï„Î¹ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Ï„Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
  if (isLastPlayer && isLastRound) {
    console.log("ğŸ“œ ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ±Î½! Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„ÎµÎ»Î¹ÎºÎ®Ï‚ ÎºÎ¬ÏÏ„Î±Ï‚...");
    showResultsSummary();
    return;
  }

  // Î”Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¬, Ï€ÏÎ¿Ï‡Ï‰ÏÎ¬Î¼Îµ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Ï€Î±Î¯ÎºÏ„Î· Î® Î³ÏÏÎ¿
  game.activeIndex++;

  // Î‘Î½ Ï€ÎµÏÎ¬ÏƒÎ±Î¼Îµ Ï„Î¿Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Ï€Î±Î¯ÎºÏ„Î·, Ï€Î¬Î¼Îµ ÏƒÏ„Î¿Î½ Ï€ÏÏÏ„Î¿ Ï„Î¿Ï… ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï… Î³ÏÏÎ¿Ï…
  if (game.activeIndex >= game.players.length) {
    game.activeIndex = 0;
    game.currentRound++;
    console.log(`ğŸ” ÎÎ­Î¿Ï‚ Î³ÏÏÎ¿Ï‚: ${game.currentRound}/${game.totalRounds}`);
  }

  // âœ… ÎšÎ»Î®ÏƒÎ· Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î±Ï‚ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï… Ï€Î±Î¯ÎºÏ„Î·
  prepareNextPlayer();
} // <â€” Î•Î”Î© Î•ÎšÎ›Î•Î™ÎÎ•Î™ Î¤Î©Î¡Î‘ Î— advanceTurn()


/* ---------- Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï… Ï€Î±Î¯ÎºÏ„Î· ---------- */
function prepareNextPlayer() {
  console.log("%câš™ï¸ Î•ÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ prepareNextPlayer()", "color: #6ee0ff; font-weight: bold;");

  // ğŸ§¹ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€ÎµÎ´Î¯Ï‰Î½ Ï€ÏÎ¹Î½ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï‚ Ï€Î±Î¯ÎºÏ„Î·Ï‚
  document.getElementById("transcript").value = "";
  document.getElementById("socraticComment").textContent = "â€”";
  document.getElementById("criteriaList").innerHTML = "";

  // âœ… Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ‰ÏƒÏ„Î¿Ï Ï€Î±ÏÎ¿Î½Î¿Î¼Î±ÏƒÏ„Î® Ï€ÏÎ¹Î½ ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯
  const active = getActiveManualCriteria(game.mode || "simple", game.currentRound);
  const baseMax = active.reduce((s, c) => s + c.max, 0);
  document.getElementById("totalScore").textContent = `â€”/${baseMax}`;
  document.getElementById("timer").textContent = "1:30";

  remainingTime = game.baseTimeSec;
  clearInterval(timerInterval);
  isTimerRunning = false;
  isPaused = false;

  renderActivePlayer();
  updateTimeBar(game.baseTimeSec); // âœ… Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¼Ï€Î¬ÏÎ±Ï‚ Ï‡ÏÏŒÎ½Î¿Ï…
}

  // âœ… Î•Ï€Î±Î½ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· bonus Î³Î¹Î± Ï„Î¿Î½ Î½Î­Î¿ Ï€Î±Î¯ÎºÏ„Î· (Î±Î½ Î´Î¹ÎºÎ±Î¹Î¿ÏÏ„Î±Î¹)
  const bonusBtn = document.getElementById("bonusBtn");
  if (bonusBtn) bonusBtn.disabled = (game.players[game.activeIndex].bonusLeft <= 0);

/* ---------- Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± (Î¼Îµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ ÎºÏÎ¹Ï„Î®ÏÎ¹Î±) ---------- */
function buildDetailsHTML() {
  let html = `<table id="detailsTable" style="width:100%;border-collapse:collapse;text-align:center;font-size:15px;">
    <thead>
      <tr style="background:rgba(255,255,255,0.1);">
        <th style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.2);">Î Î±Î¯ÎºÏ„Î·Ï‚</th>`;

  // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎµÏ†Î±Î»Î¯Î´Ï‰Î½ Î³Î¹Î± Î³ÏÏÎ¿Ï…Ï‚
  for (let r = 1; r <= game.totalRounds; r++) {
    html += `<th style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.2);">Î“ÏÏÎ¿Ï‚ ${r}</th>`;
  }

  html += `<th style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.2);">Î£ÏÎ½Î¿Î»Î¿</th>
    </tr>
    </thead><tbody>`;

  // Î£ÎµÎ¹ÏÎ­Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï€Î±Î¯ÎºÏ„Î·
  game.players.forEach(p => {
    const arr = game.scores[p.name] || [];
    const validNumbers = arr.map(v => (typeof v === "number" ? v : 0));
    const sum = validNumbers.reduce((a, b) => a + b, 0);

    html += `<tr>
      <td style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);color:${p.color};font-weight:bold;">${p.name}</td>`;

    // Î“Î¹Î± ÎºÎ¬Î¸Îµ Î³ÏÏÎ¿, Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ ÏƒÎºÎ¿Ï ÎºÎ±Î¹ (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½) Ï„Î± ÎµÏ€Î¹Î¼Î­ÏÎ¿Ï…Ï‚ ÎºÏÎ¹Ï„Î®ÏÎ¹Î±
    for (let r = 0; r < game.totalRounds; r++) {
      const roundData = (game.criteriaDetails?.[p.name]?.[r + 1]) || {};
      const subCriteria = Object.entries(roundData)
        .map(([k, v]) => `${k}: ${v}`)
        .join("<br>");
      html += `<td style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);font-size:13px;">
        <b>${validNumbers[r] ?? "â€”"}</b><br><span style="opacity:0.8;font-size:12px;">${subCriteria || ""}</span>
      </td>`;
    }

    html += `<td style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:bold;">${sum}</td></tr>`;
  });

  html += `</tbody></table>`;
  return html;
}
  
function showResultsSummary() {
  const totalScores = {};
  const playerSummaries = [];

  // ğŸ”¹ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€ÏŒÎ½Ï„Ï‰Î½ Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï€Î±Î¯ÎºÏ„Î·
  game.players.forEach(p => {
    const arr = game.scores[p.name] || [];
    const validNumbers = arr.filter(n => typeof n === "number" && !isNaN(n));

   const roundScores = validNumbers.map((n, i) => {
  const denom = (game.outOfs?.[p.name]?.[i] ?? "â€”");
  return `Î“ÏÏÎ¿Ï‚ ${i + 1}: ${n}/${denom}`;
});
    const sum = validNumbers.reduce((a, b) => a + b, 0);

    totalScores[p.name] = sum;

    playerSummaries.push(`
      <li style="margin-bottom:12px;">
        <strong style="color:${p.color}">${p.name}</strong><br>
        <span style="font-size:14px;opacity:0.9">${roundScores.join(" | ")}</span><br>
        <span style="font-size:15px;">Î£ÏÎ½Î¿Î»Î¿: <b>${sum}</b></span>
      </li>
    `);
  });

  // âœ… Î•Ï€Î¹Î»Î¿Î³Î® ÏÎ®ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚ Ï†Î¹Î»Î¿ÏƒÏŒÏ†Î¿Ï…
  const currentMission = document.getElementById("missionSelect").value;
  const availableQuotes = quotesByMission[currentMission] || [];

  let quoteHTML = ""; // Ï‡Ï‰ÏÎ¯Ï‚ fallback

  if (availableQuotes.length > 0) {
    const random = Math.floor(Math.random() * availableQuotes.length);
    const q = availableQuotes[random];
    const imgSrc = philosopherImages[q.author] || "images/Socrates.png";

    quoteHTML = `
      <div style="display:flex; align-items:center; justify-content:center; gap:16px; flex-wrap:wrap;">
        <div style="position:relative; width:90px; height:90px;">
    <img src="${imgSrc}" alt="${q.author}"
     style="width:90px;height:90px;border-radius:50%;
     object-fit:cover;border:3px solid #6ee0ff;background:none;box-shadow:0 0 10px #6ee0ff;">
        </div>
        <div style="max-width:420px; text-align:left;">
          <p style="font-style:italic; font-size:18px; margin:0;">Â«${q.quote}Â»</p>
          <p style="text-align:right; margin-top:6px; font-weight:bold;">â€” ${q.author}</p>
        </div>
      </div>
    `;
  }

  document.getElementById("socratesQuote").innerHTML = quoteHTML;

  // ğŸ† Î•ÏÏÎµÏƒÎ· Î½Î¹ÎºÎ·Ï„Î®
  let winnerText = "â€”";
  const entries = Object.entries(totalScores);
  if (entries.length > 0) {
    // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î½Î¹ÎºÎ·Ï„Î® Î® Î¹ÏƒÎ¿Î²Î±Î¸Î¼Î¯Î±Ï‚
entries.sort((a, b) => b[1] - a[1]);
const highest = entries[0][1];
const winners = entries.filter(([_, score]) => score === highest).map(([name]) => name);

if (winners.length === 1) {
  winnerText = `ğŸ† ÎÎ¹ÎºÎ·Ï„Î®Ï‚: ${winners[0]} Î¼Îµ ÏƒÏÎ½Î¿Î»Î¿ ${highest} Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚!`;
} else {
  winnerText = `ğŸ¤ Î™ÏƒÎ¿Î²Î±Î¸Î¼Î¯Î± Î¼ÎµÏ„Î±Î¾Ï: ${winners.join(", ")} Î¼Îµ ÏƒÏÎ½Î¿Î»Î¿ ${highest} Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚!`;
}
  } else {
    winnerText = "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î± ÏƒÎºÎ¿Ï.";
  }

  // ğŸ“‹ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î»Î¯ÏƒÏ„Î±Ï‚ Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½
  const html = `
    <ul style="list-style:none; padding:0; text-align:left; margin-top:15px;">
      ${playerSummaries.join("")}
    </ul>
    <p style="margin-top:15px; font-size:17px;">${winnerText}</p>
  `;

  // ğŸª„ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· modal
  document.getElementById("resultsSummary").innerHTML = html;
  document.getElementById("resultModal").style.display = "flex";

  // ğŸ”” Î‰Ï‡Î¿Ï‚ - Î£Ï‰ÎºÏÎ¬Ï„ÎµÎ¹Î¿ ÎšÎ±Î¼Ï€Î±Î½Î¬ÎºÎ¹
  try {
    const audio = new Audio("sounds/philosophical_chime.mp3");
    audio.volume = 0.6;
    audio.currentTime = 0;
    audio.play().catch(err => console.warn("Audio blocked:", err));

    const modalBox = document.querySelector("#resultModal > div");
    if (modalBox) {
      modalBox.classList.add("glow");
      setTimeout(() => modalBox.classList.remove("glow"), 1500);
    }
  } catch (e) {
    console.warn("Audio failed:", e);
  }

  // ğŸ” Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® â†’ Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ®
  document.getElementById("nextMissionBtn").onclick = () => {
    document.getElementById("resultModal").style.display = "none";
    document.getElementById("welcomeScreen").style.display = "flex";
    document.getElementById("setupScreen").style.display = "none";
    document.querySelector(".app").scrollIntoView({ behavior: "smooth" });
    game.scores = {};
    game.currentRound = 1;
    game.activeIndex = 0;
    renderActivePlayer();
  };
}
  
/* === ÎÎ•Î•Î£ Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ === */
function updateTimeBar(durationSec) {
  const bar = document.getElementById("timeBar");
  if (!bar || !durationSec) return;
  const progress = Math.max(0, (remainingTime / durationSec) * 100);
  bar.style.width = progress + "%";
}

function zeroTimer() {
  clearInterval(timerInterval);
  isTimerRunning = false;
  isPaused = false;
  remainingTime = 0;
  document.getElementById("timer").textContent = "0:00";
  updateTimeBar(1);
}

// âœ… ÎŒÏ„Î±Î½ Ï„ÎµÎ»ÎµÎ¹ÏÎ½ÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚: ÎºÎ±Î¼Ï€Î±Î½Î¬ÎºÎ¹ + Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· (Î§Î©Î¡Î™Î£ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ next)
function handleTimeUp() {
  // Î£Ï„Î±Î¼Î¬Ï„Î± Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ Ï„ÏÎ­Ï‡ÎµÎ¹
  try { if (recognition && recognizing) recognition.stop(); } catch {}
  clearInterval(timerInterval);
  isTimerRunning = false;
  isPaused = false;
  remainingTime = 0;

  // UI
  document.getElementById("timer").textContent = "â° Î¤Î­Î»Î¿Ï‚!";
  updateTimeBar(1);

    // ğŸš« ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± bonus ÏŒÏ„Î±Î½ Î»Î®Î¾ÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ (ÏŒÏ‡Î¹ +30â€³ Î¼ÎµÏ„Î¬)
  const bonusBtn = document.getElementById("bonusBtn");
  if (bonusBtn) bonusBtn.disabled = true;

  // Î‰Ï‡Î¿Ï‚
  try {
    const audio = new Audio("sounds/philosophical_chime.mp3");
    audio.volume = 0.6;
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  } catch {}

  // Popup
  showSocratesPopup();

  // âœ… Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ· (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎµÎ¯Î¼ÎµÎ½Î¿)
  const transcript = document.getElementById("transcript").value.trim();
  if (!transcript) {
    alert("â° Î¤Î­Î»Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï…! Î“ÏÎ¬ÏˆÎµ/Ï€ÎµÏ‚ Î¼Î¹Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎºÎ±Î¹ Ï€Î¬Ï„Î± Â«Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Â».");
    return;
  }

  const scoreBtn = document.getElementById("scoreBtn");
  if (scoreBtn && !scoreBtn.disabled) {
    // Î¼Î¹ÎºÏÎ® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ· Î³Î¹Î± Î½Î± â€œÎºÎ»ÎµÎ¯ÏƒÎµÎ¹â€ ÎºÎ±Î¸Î±ÏÎ¬ Ï„Î¿ speech recognition
    setTimeout(() => scoreBtn.click(), 80);
  }
}
  
/* === ÎÎ•Î‘ startTimer === */
function startTimer(durationSec = 90) {
  if (isTimerRunning && !isPaused) return; // Î‘Î½ Î®Î´Î· Ï„ÏÎ­Ï‡ÎµÎ¹, Î¼Î·Î½ Î¾Î±Î½Î±Î¾ÎµÎºÎ¹Î½Î¬

  clearInterval(timerInterval);
  isTimerRunning = true;
  isPaused = false;

  if (remainingTime <= 0 || remainingTime > durationSec) {
    remainingTime = durationSec;
  }

  function updateDisplay() {
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    document.getElementById("timer").textContent =
      `${minutes}:${seconds.toString().padStart(2, "0")}`;
  }

  updateDisplay();
  updateTimeBar(durationSec);

  timerInterval = setInterval(() => {
    if (isPaused) return;
    remainingTime--;
    updateTimeBar(durationSec);

    // ğŸ”´ Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î³Î¹Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± 10"
const bar = document.getElementById("timeBar");
if (bar) {
  if (remainingTime <= 10) bar.classList.add("warning");
  else bar.classList.remove("warning");
}

    if (remainingTime < 0) {
      handleTimeUp();   // âœ… ÎºÎ±Î¼Ï€Î±Î½Î¬ÎºÎ¹ + auto-score, Ï‡Ï‰ÏÎ¯Ï‚ auto next
      return;
    }

    updateDisplay();
  }, 1000);
}

/* ---------- Text-to-Speech (Socrates) ---------- */
document.getElementById("speakBtn").addEventListener("click", ()=>{
  const comment = document.getElementById("socraticComment").textContent.trim();
  if(!comment || comment==="â€”"){ 
    alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ‡ÏŒÎ»Î¹Î¿ Î³Î¹Î± Î½Î± Î´Î¹Î±Î²Î±ÏƒÏ„ÎµÎ¯.");
    return;
  }
  const utterance = new SpeechSynthesisUtterance(comment);
  const voices = speechSynthesis.getVoices();
  const greekVoice = voices.find(v => v.lang.startsWith("el"));
  if(greekVoice) utterance.voice = greekVoice;
  speechSynthesis.speak(utterance);
});

/* ---------- Speech-to-Text ---------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let recognizing = false;
let finalTranscript = "";
let shouldListen = false;

function initSTT(){
  if(!SpeechRecognition){
    alert("ÎŸ browser Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Speech Recognition. Î ÏÏŒÏ„ÎµÎ¹Î½ÎµÏ„Î±Î¹ Chrome ÏƒÎµ desktop/Android.");
    return;
  }
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = document.getElementById("langSelect").value;

  recognition.onstart = () => {
    recognizing = true;
    const listenBtn = document.getElementById("listenBtn");
    listenBtn.classList.add("recording");
    listenBtn.textContent = "â–  Î£Ï„Î±Î¼Î¬Ï„Î± Ï„Î·Î½ Î±ÎºÏÏŒÎ±ÏƒÎ·";
    listenBtn.style.background = "linear-gradient(135deg,#ffb6b9,#ff6f61)";
    document.getElementById("timerPanel").style.opacity = "1";
  };

  recognition.onend = () => {
    recognizing = false;
    const listenBtn = document.getElementById("listenBtn");
    if (isPaused) {
      listenBtn.textContent = "â¸ï¸ Î Î±ÏÏƒÎ·";
      listenBtn.style.background = "gray";
    } else {
      listenBtn.textContent = "â–¶ï¸ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î±ÎºÎ¿ÏÎµÎ¹/Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹";
      listenBtn.style.background = "linear-gradient(135deg,#cde7ff,#caa5ff)";
    }
    listenBtn.classList.remove("recording");
  };

  recognition.onerror = (e) => {
    console.warn("STT error:", e.error);
  };

  recognition.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      if (res.isFinal) finalTranscript += res[0].transcript + " ";
      else interim += res[0].transcript;
    }
    document.getElementById("transcript").value = (finalTranscript + " " + interim).trim();
  };
}

/* ---------- Listen button ---------- */
document.getElementById("listenBtn").addEventListener("click", () => {
  if (!recognition) initSTT();
  if (!recognition) return;

  const listenBtn = document.getElementById("listenBtn");
  const timerPanel = document.getElementById("timerPanel");

  if (!recognizing) {
    finalTranscript = document.getElementById("transcript").value.trim() + " ";
    recognition.lang = document.getElementById("langSelect").value;

    try { recognition.start(); } catch (err) { console.warn(err); return; }
    if (!isTimerRunning) startTimer(game.baseTimeSec || 90);

    isPaused = false;
    timerPanel.style.opacity = "1";
    removeSocratesPauseMessage();

  } else {
    isPaused = true;
    try { recognition.stop(); } catch (err) { console.warn(err); }

    timerPanel.style.opacity = "0.6";
    listenBtn.textContent = "â¸ï¸ Î Î±ÏÏƒÎ·";
    listenBtn.style.background = "gray";
    showSocratesPauseMessage();
  }
});

/* ---------- Mission select ---------- */
document.getElementById("missionSelect").addEventListener("change", (e)=>{
  renderMission(e.target.value);
});

/* ---------- Start timer on typing ---------- */
document.getElementById("transcript").addEventListener("input", () => {
  if (!isTimerRunning) {
    startTimer(game.baseTimeSec || 90);
  }
});
  
/* ---------- Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î£Ï‰ÎºÏÎ¬Ï„Î· (AI / Offline / Manual) ---------- */
async function getScore(transcript, mission) {
  console.log("âš™ï¸ Î•ÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ getScore() â€” Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±:", judgeMode);

    // ğŸ¤– AI ÎšÏÎ¹Ï„Î®Ï‚ (API)
  if (judgeMode === "ai") {
    console.log("ğŸ¤– Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ AI ÎšÏÎ¹Ï„Î®Ï‚ (API Mode)");
    return await getAIScore(transcript, mission);
  }

  // ğŸ’» Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ ÎšÏÎ¹Ï„Î®Ï‚ (Offline Rubric)
  if (judgeMode === "offline") {
    console.log("ğŸ’» Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ ÎšÏÎ¹Ï„Î®Ï‚ (Offline Mode)");
    return await getOfflineScore(transcript, mission);
  }

  // ğŸ‘¤ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚ (Manual)
  if (judgeMode === "manual") {
    console.log("ğŸ‘¤ Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚ (Manual Mode)");
    return await getManualScore();
  }

 

  // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚
  console.warn("âš ï¸ Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ ÎšÏÎ¹Ï„Î® â€“ ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÏ„Î±Î¹ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®");
  return { criteria: {}, total: null, feedback: "" };
}

/* ---------- AI ÎšÏÎ¹Ï„Î®Ï‚ (API) ---------- */
async function getAIScore(transcript, mission) {
  try {
    console.log("ğŸ§¾ transcript:", transcript);
    console.log("ğŸ“˜ mission:", mission);

  // ğŸ§  ÎœÎ½Î®Î¼Î· Ï€Î±Î¯ÎºÏ„Î·
const activePlayer = game.players[game.activeIndex].name;
const memory = playerPositions[activePlayer] || {};

// ğŸš€ ÎšÎ»Î®ÏƒÎ· API /api/score
const response = await fetch("/api/score", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
   body: JSON.stringify({
    transcript,
    mission,

    // âœ… ÎÎ•ÎŸ: ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹ Ï„Î¿ /api/score
    philosopherContext: {
      philosopher: memory.philosopher || null,
      position: memory.thesis || null
    },

  round: game.currentRound,
mode: game.mode || "simple",

// ğŸ§  ÎœÎ½Î®Î¼Î· ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± Î¼Î· Î´Î¹Ï€Î»Î¿Î¼ÎµÏ„ÏÎ¬ÎµÎ¹ Î•Î¹ÎºÏŒÎ½Î± ÎºÎ±Î¹ ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ Î¼ÎµÏ„Î±Î¾Ï Î³ÏÏÏ‰Î½
debateState: {
  imageScored: !!(playerPositions?.[activePlayer]?.imageScored),
  metaphorScored: !!(playerPositions?.[activePlayer]?.metaphorScored)
}
  })
});

// Î‘Ï€ÏŒ ÎµÎ´Ï ÎºÎ±Î¹ ÎºÎ¬Ï„Ï‰, Î¾ÎµÎºÎ¹Î½Î¬ Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Ï„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ±:
if (!response.ok) {
  console.error("âŒ API HTTP error:", response.status);
  throw new Error("HTTP " + response.status);
}

const result = await response.json();
console.log("ğŸ“¨ AI Response:", result);

// ğŸ§  Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¼Î½Î®Î¼Î·Ï‚ ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ·Ï‚ (Î•Î¹ÎºÏŒÎ½Î± / ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬) ÎœÎŸÎÎŸ Î±Î½ Ï€Î®ÏÎ±Î½ Ï€ÏŒÎ½Ï„Î¿Ï…Ï‚
playerPositions[activePlayer] = playerPositions[activePlayer] || {};

if (Number(result?.criteria?.["Î•Î¹ÎºÏŒÎ½Î±"]) > 0) {
  playerPositions[activePlayer].imageScored = true;
}

if (Number(result?.criteria?.["ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬"]) > 0) {
  playerPositions[activePlayer].metaphorScored = true;
}


// âœ… Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Ï out_of ÏƒÏ„Î¿ global Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿
window.scores = window.scores || {};
window.scores.out_of = result.out_of;
    
// ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎµÎ³ÎºÏ…ÏÏŒÏ„Î·Ï„Î±Ï‚
if (!result || typeof result.total === "undefined") {
  throw new Error("ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î· (API)");
}

return {
  criteria: result.criteria || {},
  total: result.total,
  feedback: result.feedback || "ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÎ¹ÏÏ€Î·ÏƒÎµ, Î±Î»Î»Î¬ ÏƒÎºÎ­Ï†Ï„Î·ÎºÎµ ÎºÎ¬Ï„Î¹ Î²Î±Î¸Ïâ€¦"
};

} catch (err) {
  console.error("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·:", err);
  // Fallback ÏƒÏ„Î¿Î½ offline ÎºÏÎ¹Ï„Î®
  return await getOfflineScore(transcript, mission);
}
}

  
/* ---------- Î•Ï€Î¹Î»Î¿Î³Î® Ï„ÏÏŒÏ€Î¿Ï… ÎšÏÎ¹Ï„Î® ---------- */
// ai = API, offline = Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ (rubric), manual = Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚

function setJudgeMode(mode) {
  judgeMode = mode;
  const modeNames = {
    ai: "ğŸ¤– AI ÎšÏÎ¹Ï„Î®Ï‚ (API)",
    offline: "ğŸ’» Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ ÎšÏÎ¹Ï„Î®Ï‚ (Rubric)",
    manual: "ğŸ‘¤ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚"
  };
  console.log(`âš™ï¸ Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ: ${modeNames[mode] || "Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚"}`);
  const indicator = document.getElementById("judgeModeIndicator");
  if (indicator) {
    indicator.textContent = `Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±: ${modeNames[mode] || "â€”"}`;
  }
}

/* ---------- Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ ÎšÏÎ¹Ï„Î®Ï‚ (Offline / Local) ---------- */
async function getOfflineScore(transcript, mission) {
  const { localJudge } = await import("./utils/localJudge.js");

  const result = await localJudge({
    transcript,
    mission,
    rubric: MANUAL_RUBRIC
  });

  return result;
}

 /* ---------- Manual Rubric (Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î±Ï€ÏŒ Î¬Î½Î¸ÏÏ‰Ï€Î¿) ---------- */
async function getManualScore() {
  // 1) Î•Î½ÎµÏÎ³Î¬ ÎºÏÎ¹Ï„Î®ÏÎ¹Î± Î¼Îµ Î²Î¬ÏƒÎ· Î“ÏÏÎ¿ & ÎˆÎºÎ´Î¿ÏƒÎ·
  const active = getActiveManualCriteria(game.mode || "simple", game.currentRound);

  // 2) Î¦Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ Ï„Î± inputs
  const container = document.getElementById("manualInputs");
  container.innerHTML = "";

  const isFirstRound = game.currentRound === 1;
  const roundLabel = isFirstRound
    ? "ğŸ”¹ 1Î¿Ï‚ Î³ÏÏÎ¿Ï‚ (Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ 'Î˜Î­ÏƒÎ·', Ï‡Ï‰ÏÎ¯Ï‚ 'Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·')"
    : `ğŸ”¸ ${game.currentRound}Î¿Ï‚ Î³ÏÏÎ¿Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ 'Î˜Î­ÏƒÎ·', Î¼Îµ 'Î‘Î½Ï„Î¯ÏÏÎ·ÏƒÎ·')`;

  const header = document.createElement("p");
  header.textContent = roundLabel;
  header.style.fontStyle = "italic";
  header.style.opacity = "0.9";
  container.appendChild(header);

  // ğŸ§  ÎœÎ½Î®Î¼Î· Ï€Î±Î¯ÎºÏ„Î· (Î•Î¹ÎºÏŒÎ½Î±/ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬)
  const activePlayer = game.players[game.activeIndex].name;
  const memory = playerPositions[activePlayer] || {};

  // 3) Î ÎµÎ´Î¯Î¿ Î±Î½Î¬ ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿
  active.forEach(c => {
    const row = document.createElement("div");
    row.style.margin = "6px 0";

    const label = document.createElement("label");
    label.style.display = "inline-flex";
    label.style.alignItems = "center";
    label.style.gap = "6px";

    const span = document.createElement("span");
    span.textContent = `${c.key}:`;

    const input = document.createElement("input");
    const keyId = `crit_${String(c.key).replace(/\s+/g, "_")}`;
    input.id = keyId;
    input.type = "number";
    input.min = 0;
    input.max = c.max;
    input.step = 1;
    input.value = 0;
    input.style.width = "60px";
    input.style.textAlign = "center";

    let disabledReason = null;
    if (c.key === "Î•Î¹ÎºÏŒÎ½Î±" && memory.imageScored) {
      disabledReason = "ÎˆÏ‡ÎµÎ¹ Î®Î´Î· Î±Î¾Î¹Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÎµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î³ÏÏÎ¿";
    }
    if (c.key === "ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬" && memory.metaphorScored) {
      disabledReason = "ÎˆÏ‡ÎµÎ¹ Î®Î´Î· Î±Î¾Î¹Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÎµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ Î³ÏÏÎ¿";
    }

    if (disabledReason) {
      input.disabled = true;
      input.value = 0;
      input.style.opacity = "0.6";
    }

    input.addEventListener("input", () => {
      if (input.value === "") return;
      let val = parseInt(input.value, 10);
      if (isNaN(val) || val < 0) val = 0;
      if (val > c.max) val = c.max;
      input.value = val;
    });

    label.appendChild(span);
    label.appendChild(input);
    label.insertAdjacentHTML("beforeend", ` /${c.max}`);

    if (disabledReason) {
      const note = document.createElement("span");
      note.textContent = `(${disabledReason})`;
      note.style.fontSize = "0.8em";
      note.style.opacity = "0.8";
      note.style.marginLeft = "6px";
      label.appendChild(note);
    }

    row.appendChild(label);
    container.appendChild(row);
  });

  // 4) Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· modal
  const modal = document.getElementById("manualModal");
  modal.style.display = "flex";

  // 5) out_of (Ï‡Ï‰ÏÎ¯Ï‚ bonus)
  const outOf = active.reduce((s, c) => s + (c.max || 0), 0);

  // 6) Î¥Ï€Î¿Î²Î¿Î»Î® / Î‘ÎºÏÏÏ‰ÏƒÎ·
  return new Promise(resolve => {
    document.getElementById("manualSubmit").onclick = () => {
      const scores = {};
      let total = 0;

      active.forEach(c => {
        const keyId = `crit_${String(c.key).replace(/\s+/g, "_")}`;
        const val = parseInt(document.getElementById(keyId)?.value, 10) || 0;
        scores[c.key] = val;
        total += val;
      });

      // ğŸ§  Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¼Î½Î®Î¼Î·Ï‚ ÏÏƒÏ„Îµ Î½Î± Î¼Î· Î¾Î±Î½Î±Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ ÏƒÎµ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î³ÏÏÎ¿
      playerPositions[activePlayer] = playerPositions[activePlayer] || {};
      if ((scores["Î•Î¹ÎºÏŒÎ½Î±"] || 0) > 0) playerPositions[activePlayer].imageScored = true;
      if ((scores["ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬"] || 0) > 0) playerPositions[activePlayer].metaphorScored = true;

      modal.style.display = "none";
      resolve({
        criteria: scores,
        criteriaMax: Object.fromEntries(active.map(c => [c.key, c.max])),
        total,
        out_of: outOf,
        feedback: "ğŸ“‹ ÎŸÎ¹ Î²Î±Î¸Î¼Î¿Î¯ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎ±Î½ Î±Ï€ÏŒ Ï„Î¿Î½ ÎšÏÎ¹Ï„Î®."
      });
    };

    document.getElementById("manualCancel").onclick = () => {
      modal.style.display = "none";
      resolve({
        criteria: {},
        criteriaMax: {},
        total: 0,
        out_of: outOf,
        feedback: "â¸ï¸ Î— Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ."
      });
    };
  });
}

/* ---------- Score button ---------- */
document.getElementById("scoreBtn").addEventListener("click", async ()=> {

  // ğŸ›¡ï¸ 1. Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î±Ï€ÏŒ Î´Î¹Ï€Î»ÏŒ Ï€Î¬Ï„Î·Î¼Î±
  const button = document.getElementById("scoreBtn");
  if (button.disabled) {
    console.warn("â³ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î®Î´Î· ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹ â€” Ï€ÎµÏÎ¯Î¼ÎµÎ½Îµ Î»Î¯Î³Î¿!");
    return;
  }

  // ğŸš« Î‘Î½ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¿Î»Î¿ÎºÎ»Î·ÏÏÏƒÎµÎ¹ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î³ÏÏÎ¿, Î¼Î·Î½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹Ï‚ Î½Î­Î± Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±
  const currentPlayer = game.players[game.activeIndex].name;
  if (game.completedRounds?.[currentPlayer]?.includes(game.currentRound)) {
    alert(`ÎŸ ${currentPlayer} Î­Ï‡ÎµÎ¹ Î®Î´Î· Î¿Î»Î¿ÎºÎ»Î·ÏÏÏƒÎµÎ¹ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î³ÏÏÎ¿.`);
    return;
  }
  
  // â›” Î‘Î½ Î¿ Ï€Î±Î¯ÎºÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î³ÏÏÎ¿
  if (
    game.scores[currentPlayer] &&
    typeof game.scores[currentPlayer][game.currentRound - 1] === "number"
  ) {
    const retry = confirm(`ÎŸ ${currentPlayer} Î­Ï‡ÎµÎ¹ Î®Î´Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î³ÏÏÎ¿.\nÎ˜ÎµÏ‚ Î½Î± ÎµÏ€Î±Î½Î±Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î·Î¸ÎµÎ¯;`);
    if (!retry) return; // âŒ ÏƒÏ„Î±Î¼Î¬Ï„Î± Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€Î±Ï„Î®ÏƒÎµÎ¹ "Î†ÎºÏ…ÏÎ¿"
  }

  // ğŸ§  ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏ€Î±ÏÎ¾Î·Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï Ï€Î±Î¯ÎºÏ„Î· ÎºÎ±Î¹ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚
  if (!currentPlayer) {
    alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³ÏŒÏ‚ Ï€Î±Î¯ÎºÏ„Î·Ï‚!");
    return;
  }

  const transcript = document.getElementById("transcript").value.trim();
  if (!transcript) {
    alert("ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î´ÎµÎ½ Î¬ÎºÎ¿Ï…ÏƒÎµ Ï„Î¯Ï€Î¿Ï„Î± Î³Î¹Î± Î½Î± Î±Î¾Î¹Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹!");
    return;
  }

  // âš™ï¸ 2. Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï â€œÎ£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€
  button.disabled = true;
  button.textContent = "â³ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹...";
  button.style.opacity = "0.6";

  // â° 3. Auto-timeout Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± (25")
  const safeguard = setTimeout(() => {
    if (button.disabled) {
      button.disabled = false;
      button.textContent = "âš–ï¸ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±";
      button.style.opacity = "1";
      alert("â° Î¤Î¿ AI ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎµ Ï€Î¿Î»Ï. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬ Î® Î¬Î»Î»Î±Î¾Îµ ÏƒÎµ offline Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·.");
    }
  }, 25000);

  console.log("ğŸŸ¢ Î Î±Ï„Î®Î¸Î·ÎºÎµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±");

  try {
    // ğŸ§  Î”Î¹Î±ÎºÎ¿Ï€Î® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·Ï‚ Ï†Ï‰Î½Î®Ï‚ ÎºÎ±Î¹ Ï€Î±ÏÏƒÎ· Ï‡ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿Ï…
    try { if (recognition && recognizing) recognition.stop(); } catch {}
    isPaused = false;
    zeroTimer();

    const missionId = document.getElementById("missionSelect").value;
    const mission = missions.find(m => m.id === missionId);

    // ğŸ”¹ ÎšÎ»Î®ÏƒÎ· Ï„Î¿Ï… Î±Î»Î³Î¿ÏÎ¯Î¸Î¼Î¿Ï… Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚
    const scores = await getScore(transcript, mission);
    clearTimeout(safeguard);

    if (!scores || scores.error) throw new Error("ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î·");

    // ğŸ’¬ Î£Ï‡ÏŒÎ»Î¹Î¿ ÎºÎ±Î¹ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚
    let comment = scores.feedback?.trim() || "";
    if (!comment) comment = "ÎšÎ±Î»Î® Î±ÏÏ‡Î®! Î”ÏÏƒÎµ Î»Î¯Î³Î¿ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· ÎµÎ¾Î®Î³Î·ÏƒÎ· ÏƒÏ„Î¿ Â«Î³Î¹Î±Ï„Î¯Â».";

    document.getElementById("socraticComment").textContent = comment;

// âš–ï¸ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎºÏÎ¹Ï„Î·ÏÎ¯Ï‰Î½ (Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬)
const criteriaList = document.getElementById("criteriaList");
criteriaList.innerHTML = "";

if (scores.criteria && Object.keys(scores.criteria).length > 0) {
  // âœ… Î ÏÎ¿Î²Î¿Î»Î® Î±Î½Î±Î»Ï…Ï„Î¹ÎºÏÎ½ ÎºÏÎ¹Ï„Î·ÏÎ¯Ï‰Î½

for (const [key, val] of Object.entries(scores.criteria)) {
  const li = document.createElement("li");

  // ğŸ”¹ Î‘Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· ÏƒÏ„Î¿ rubricWeights.json Î³Î¹Î± Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ max
  const rubricCriterion = MANUAL_RUBRIC.criteria.find(c => c.key === key);
  const max = rubricCriterion ? rubricCriterion.max : 2; // fallback = 2

  // âœ… Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ„Î¿ max
  const safeVal = Math.min(val, max);

  li.textContent = `${key}: ${safeVal}/${max}`;
  criteriaList.appendChild(li);
}
  
} else {
  const li = document.createElement("li");
  li.textContent = "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î³ÏÏÎ¿.";
  criteriaList.appendChild(li);
}
    
   
    // ğŸ§® Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ®Ï‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±Ï‚
    let totalNum = 0;
    if (scores.total) {
      const match = String(scores.total).match(/\d+(\,\d+|\.\d+)?/);
      if (match) totalNum = parseFloat(match[0].replace(",", "."));
    }

  // âœ… ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Ï ÏƒÎºÎ¿Ï ÎºÎ±Î¹ Î´Ï…Î½Î±Î¼Î¹ÎºÎ¿Ï Ï€Î±ÏÎ¿Î½Î¿Î¼Î±ÏƒÏ„Î®
let total = Number(scores.total ?? 0);
let out_of;

if (scores.out_of && !isNaN(scores.out_of)) {
  // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ out_of Î±Ï€ÏŒ Ï„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎ­ Ï„Î¿
  out_of = Number(scores.out_of);
} else {

// Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Ï…Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ Î±Ï€ÏŒ Ï„Î¿ rubric
let active = getActiveManualCriteria(game.mode || "simple", game.currentRound);
active = Array.from(new Map(active.map(c => [c.key, c])).values());

const baseMax = active.reduce((s, c) => s + c.max, 0);
out_of = baseMax;
}

document.getElementById("totalScore").textContent = `${total}/${out_of}`;

    // ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½
    if (!game.scores[currentPlayer]) game.scores[currentPlayer] = [];
    game.scores[currentPlayer][game.currentRound - 1] = totalNum;
    if (!game.outOfs) game.outOfs = {};
    if (!game.outOfs[currentPlayer]) game.outOfs[currentPlayer] = [];
    game.outOfs[currentPlayer][game.currentRound - 1] = out_of;
    if (!game.criteriaDetails) game.criteriaDetails = {};
    if (!game.criteriaDetails[currentPlayer]) game.criteriaDetails[currentPlayer] = {};
    game.criteriaDetails[currentPlayer][game.currentRound] = scores.criteria || {};

    // âœ… ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± Ï€Î±Î¯ÎºÏ„Î· Î¼ÎµÏ„Î¬ Ï„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·
    if (!game.completedRounds) game.completedRounds = {};
    if (!game.completedRounds[currentPlayer]) game.completedRounds[currentPlayer] = [];
    game.completedRounds[currentPlayer].push(game.currentRound);

   console.log(`âœ… Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ${currentPlayer}: ${totalNum}/${out_of}`);

  } catch (err) {
    console.error("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î²Î±Î¸Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·:", err);
    alert("âš ï¸ Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ†Î¬Î»Î¼Î± ÏƒÏ„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Ï„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î·. Î ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬!");
  } finally {
    // ğŸ§¹ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï
    button.disabled = false;
    button.textContent = "âš–ï¸ Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±";
    button.style.opacity = "1";
  }
});


/* ---------- Next player / Bonus ---------- */
document.getElementById('nextPlayerBtn').addEventListener('click', ()=>{
  // â›” ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Ï‚ ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Ï‡Ï‰ÏÎ¯Ï‚ Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±
  const currentPlayer = game.players[game.activeIndex].name;
  const roundIndex = game.currentRound - 1;

  if (
    !game.scores[currentPlayer] ||
    typeof game.scores[currentPlayer][roundIndex] !== "number"
  ) {
    alert(`Î ÏÎ­Ï€ÎµÎ¹ Ï€ÏÏÏ„Î± Î½Î± Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿Î½ ${currentPlayer} Ï€ÏÎ¹Î½ ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚!`);
    return;
  }
 
  clearInterval(timerInterval);
  isTimerRunning = false;
  isPaused = false;
  remainingTime = game.baseTimeSec; // ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï‡ÏÏŒÎ½Î¿Ï…

  advanceTurn(); // âœ… ÎµÎ½Î¹Î±Î¯Î± Î»Î¿Î³Î¹ÎºÎ® Î±Î»Î»Î±Î³Î®Ï‚ Ï€Î±Î¯ÎºÏ„Î· ÎºÎ±Î¹ Î³ÏÏÎ¿Ï…
  document.getElementById("timer").textContent = "1:30";
});

document.getElementById('bonusBtn').addEventListener('click', ()=>{

  const p = game.players[game.activeIndex];

  // â›” Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¬Î»Î»Î¿ bonus
  if (p.bonusLeft <= 0) {
    alert("â›” Î”ÎµÎ½ Î­Ï‡ÎµÎ¹Ï‚ Î¬Î»Î»Î¿ +30â€³ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿.");
    return;
  }

  // âœ… Bonus ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï€ÏÎ¹Î½ Î»Î®Î¾ÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚
  if (!isTimerRunning || remainingTime <= 0) {
    alert("â›” Î¤Î¿ +30â€³ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î¼ÏŒÎ½Î¿ Ï€ÏÎ¹Î½ Ï„ÎµÎ»ÎµÎ¹ÏÏƒÎµÎ¹ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚.");
    return;
  }

  if (p.bonusLeft > 0) {
  
    p.bonusLeft--;
    const timerEl = document.getElementById("timer").textContent;
  if(/^\d+:\d+$/.test(timerEl)){
  const [min, sec] = timerEl.split(":").map(Number);
  remainingTime = min*60 + sec + 30;
  startTimer(remainingTime);
}
renderActivePlayer();
  }
});

/* ---------- Boot ---------- */
loadMissions();
renderActivePlayer();

/* ---------- Start Game (setup â†’ app) ---------- */
document.getElementById("startGameBtn").addEventListener("click", () => {
  // ğŸ”¹ Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ ÎºÏÎ¹Ï„Î® ÎºÎ±Î¹ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚
  const judgeSelect = document.getElementById("judgeMode");
  const aiNotice = document.getElementById("aiNotice");

  // ğŸ¯ Mission lock (Setup â†’ Game)
  const missionSel = document.getElementById("missionSelectSetup");
  const selectedMissionId = missionSel?.value || (missions?.[0]?.id);

  game.missionId = selectedMissionId;   // Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ game state
  renderMission(selectedMissionId);     // Î´ÎµÎ¯Î¾Îµ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Ï€Î¬Î½Ï‰ Î¼Î­ÏÎ¿Ï‚

  // ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î±: Î´ÎµÎ½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î­Î½Î±ÏÎ¾Î·
  if (missionSel) missionSel.disabled = true;

  // (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬) ÎºÏÏÏˆÎµ ÏŒÎ»Î¿ Ï„Î¿ box Ï„Î¿Ï… setup
  const missionBox = document.getElementById("missionSetupContainer");
  if (missionBox) missionBox.style.display = "none";


  // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ· Î±ÏÏ‡Î¹ÎºÏÎ½ Î¿Î¸Î¿Î½ÏÎ½
  document.getElementById("welcomeScreen").style.display = "none";

  // Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï
  const playerCount = parseInt(document.getElementById("playerCount").value);
  const roundCount = parseInt(document.getElementById("roundCount").value);
  const useBonusEl = document.getElementById("useBonus");
  const useBonus = useBonusEl ? useBonusEl.checked : false; // âœ… Î±ÏƒÏ†Î±Î»Î®Ï‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚

  // âš™ï¸ Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Ï„ÏÏŒÏ€Î¿Ï… ÎšÏÎ¹Ï„Î® (AI / Offline / Manual)
  judgeMode = judgeSelect ? judgeSelect.value : "ai"; // âœ… default = "ai"
  useAI = (judgeMode === "ai");
  console.log("âš–ï¸ Î¤ÏÏŒÏ€Î¿Ï‚ ÎšÏÎ¹Ï„Î®:", judgeMode);
  updateJudgeModeIndicator(judgeMode);

  // âœ… Î‘ÏÏ‡Î¹ÎºÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·Ï‚ Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚
  if (aiNotice) {
    if (judgeMode === "ai") {
      aiNotice.style.opacity = "1";
      aiNotice.style.height = "auto";
    } else {
      aiNotice.style.opacity = "0";
      aiNotice.style.height = "0";
    }
  }

  // ğŸŒ€ Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÎ½Î´ÎµÎ¯Î¾ÎµÏ‰Î½ ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Î· ÎµÏ€Î¹Î»Î¿Î³Î® "Î Î¿Î¹Î¿Ï‚ ÎºÏÎ¯Î½ÎµÎ¹;"
  if (judgeSelect && !judgeSelect.dataset.bound) {
    judgeSelect.addEventListener("change", (e) => {
      judgeMode = e.target.value;
      updateJudgeModeIndicator(judgeMode);

      if (aiNotice) {
        if (judgeMode === "ai") {
          aiNotice.style.opacity = "1";
          aiNotice.style.height = "auto";
        } else {
          aiNotice.style.opacity = "0";
          aiNotice.style.height = "0";
        }
      }
    });
    judgeSelect.dataset.bound = "true"; // âœ… ÏƒÎ·Î¼Î±Î¯Î± Î³Î¹Î± Î½Î± Î¼Î·Î½ Î¾Î±Î½Î±Î´ÎµÎ¸ÎµÎ¯
  }

  const selected = Array.from(document.querySelectorAll(".character.selected"));
  if (selected.length < playerCount) {
    alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¯Î»ÎµÎ¾Îµ ÏŒÏƒÎ¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚ ÏŒÏƒÎ¿Î¹ ÎµÎ¯Î½Î±Î¹ Î¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚!");
    return;
  }

  game.players = selected.slice(0, playerCount).map(el => ({
    id: el.dataset.id,
    name: el.dataset.name,
    color: el.dataset.color,
    img: el.dataset.img,
    bonusLeft: 1
  }));
  game.currentRound = 1;
  game.totalRounds = roundCount;
  game.activeIndex = 0;

  // ğŸ² Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î·Î½ Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ·
  const exampleBtn = document.getElementById("exampleBtn");
  if (exampleBtn) {
    exampleBtn.style.display = game.mode === "advanced" ? "block" : "none";
  }

  document.getElementById("setupScreen").style.display = "none";
  renderActivePlayer();
});

  
/* ---------- Welcome â†’ Setup (Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î® Î­ÎºÎ´Î¿ÏƒÎ·Ï‚) ---------- */
async function startGame(mode) {
  // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î·Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚
  game.mode = mode;

  // âœ… ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î± ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ (Î¼ÏŒÎ½Î¿ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î®)
  const missionSel = document.getElementById("missionSelect");
  if (missionSel) missionSel.disabled = true;

  // âœ… Î¦ÏŒÏÏ„Ï‰ÏƒÎ· rubricWeights.json Ï€ÏÎ¹Î½ Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹
  if (typeof loadRubric === "function") {

    try {
      await loadRubric();
      console.log("ğŸ“˜ Rubric ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÎ¸Î·ÎºÎµ ÏƒÏ„Î·Î½ Î­Î½Î±ÏÎ¾Î· Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï.");
    } catch (err) {
      console.warn("âš ï¸ Î”ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Ï„Î¿ rubric ÏƒÏ„Î·Î½ Î­Î½Î±ÏÎ¾Î·:", err);
    }
  }

showScreen("setupScreen");

  // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î­Î½Î´ÎµÎ¹Î¾Î·Ï‚ ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î· ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½
  const display = document.getElementById("selectedModeDisplay");
  if (display) {
    if (mode === "simple") {
      display.textContent = "âœ¨ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ·: Î‘Ï€Î»Î®";
      display.style.color = "#7af77a";
    } else {
      display.textContent = "âœ¨ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÎˆÎºÎ´Î¿ÏƒÎ·: Î ÏÎ¿Ï‡Ï‰ÏÎ·Î¼Î­Î½Î·";
      display.style.color = "#ff7a7a";
    }
  }

  // âœ… Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î±ÏÏ‡Î¹ÎºÎ¿Ï Ï€Î±ÏÎ¿Î½Î¿Î¼Î±ÏƒÏ„Î® Î³Î¹Î± Ï„Î¿Î½ Ï€ÏÏÏ„Î¿ Î³ÏÏÎ¿
  if (typeof prepareNextPlayer === "function") {
    prepareNextPlayer();
    console.log("%cğŸ§® Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î¬ÏƒÏ„Î·ÎºÎµ Î¿ Ï€ÏÏÏ„Î¿Ï‚ Ï€Î±Î¯ÎºÏ„Î·Ï‚ Î¼Îµ ÏƒÏ‰ÏƒÏ„ÏŒ Ï€Î±ÏÎ¿Î½Î¿Î¼Î±ÏƒÏ„Î®.", "color: #7af77a; font-weight: bold;");
  }
}

// âœ… Î£Ï…Î½Î´Î­Î¿Ï…Î¼Îµ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Ï„Î·Ï‚ Î±ÏÏ‡Î¹ÎºÎ®Ï‚ (ÎÎ•Î‘ ÏÎ¿Î®)
const startTrialsBtn = document.getElementById("startTrialsBtn");
const startBigDiscussionBtn = document.getElementById("startBigDiscussionBtn");

const trialsScreen = document.getElementById("trialsScreen");
const modeSelectScreen = document.getElementById("modeSelectScreen");

const SCREENS = ["welcomeScreen", "trialsScreen", "modeSelectScreen", "setupScreen", "appScreen"];

function showScreen(id) {
  SCREENS.forEach(sid => {
    const el = document.getElementById(sid);
    if (!el) return;
    el.style.display = (sid === id)
      ? (sid === "appScreen" ? "block" : "flex")
      : "none";
  });
}

const backToWelcomeFromTrialsBtn = document.getElementById("backToWelcomeFromTrialsBtn");
const backToWelcomeFromModeBtn = document.getElementById("backToWelcomeFromModeBtn");

const modeSimpleBtn = document.getElementById("modeSimpleBtn");
const modeAdvancedBtn = document.getElementById("modeAdvancedBtn");

// 1) ğŸŸ¡ Î‘â€™ Î¦Î¬ÏƒÎ· â€” Î”Î¿ÎºÎ¹Î¼Î±ÏƒÎ¯ÎµÏ‚
if (startTrialsBtn) {
  startTrialsBtn.addEventListener("click", () => {
   showScreen("trialsScreen");
    if (trialsScreen) trialsScreen.style.display = "flex";
  });
}

if (backToWelcomeFromTrialsBtn) {
  backToWelcomeFromTrialsBtn.addEventListener("click", () => {
    if (trialsScreen) trialsScreen.style.display = "none";
   showScreen("welcomeScreen");
  });
}

// 2) ğŸŸ¢ ÎœÎµÎ³Î¬Î»Î· Î£Ï…Î¶Î®Ï„Î·ÏƒÎ· â†’ Î•Ï€Î¹Î»Î¿Î³Î® ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚
if (startBigDiscussionBtn) {
  startBigDiscussionBtn.addEventListener("click", () => {
    dshowScreen("modeSelectScreen");
    document.getElementById("setupScreen").style.display = "none";
    if (modeSelectScreen) modeSelectScreen.style.display = "flex";
  });
}

if (backToWelcomeFromModeBtn) {
  backToWelcomeFromModeBtn.addEventListener("click", () => {
    if (modeSelectScreen) modeSelectScreen.style.display = "none";
    document.getElementById("setupScreen").style.display = "none";
  showScreen("welcomeScreen");
  });
}

// Î•Ï€Î¹Î»Î¿Î³Î® Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ â†’ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ Ï…Ï€Î¬ÏÏ‡Î¿Î½ startGame(mode)
if (modeSimpleBtn) {
  modeSimpleBtn.addEventListener("click", () => {
    document.getElementById("setupScreen").style.display = "none";
if (modeSelectScreen) modeSelectScreen.style.display = "none";
startGame("simple");

  });
}

if (modeAdvancedBtn) {
  modeAdvancedBtn.addEventListener("click", () => {
  
if (modeSelectScreen) modeSelectScreen.style.display = "none";
startGame("advanced");
  });
}

/* ---------- Info ---------- */
document.getElementById("infoButton").addEventListener("click", () => {
  alert("ğŸ“œ ÎŸÎ´Î·Î³Î¯ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï:\n\n1ï¸âƒ£ Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ ÎºÎ±Î¹ Î³ÏÏÎ¿Ï…Ï‚.\n2ï¸âƒ£ ÎœÎ¯Î»Î± Î® Î³ÏÎ¬ÏˆÎµ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Ï„Î¿Ï… Ï€Î±Î¯ÎºÏ„Î·.\n3ï¸âƒ£ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î¸Î± Ï„Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹ ÎºÎ±Î¹ Î¸Î± ÏƒÏ‡Î¿Î»Î¹Î¬ÏƒÎµÎ¹.\n\nÎšÎ±Î»Î® Î´Î¹Î±ÏƒÎºÎ­Î´Î±ÏƒÎ·!");
});

function showSocratesPauseMessage() {
  removeSocratesPauseMessage(); // Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·
  const msg = document.createElement("div");
  msg.id = "pauseMessage";
  msg.textContent = "ğŸ”‡ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î´ÎµÎ½ Î±ÎºÎ¿ÏÎµÎ¹...";
  msg.style.position = "fixed";
  msg.style.bottom = "90px";
  msg.style.left = "50%";
  msg.style.transform = "translateX(-50%)";
  msg.style.background = "rgba(0,0,0,0.7)";
  msg.style.padding = "10px 20px";
  msg.style.borderRadius = "10px";
  msg.style.fontSize = "16px";
  msg.style.color = "#fff";
  msg.style.zIndex = "5000";
  msg.style.backdropFilter = "blur(4px)";
  document.body.appendChild(msg);
}

function removeSocratesPauseMessage() {
  const old = document.getElementById("pauseMessage");
  if (old) old.remove();
}

/* ---------- ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ Î³Î¹Î± Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î± ---------- */
window.addEventListener('DOMContentLoaded', () => {
  const detailsBtn = document.getElementById("showDetailsBtn");
  const closeBtn   = document.getElementById("closeDetailsBtn");
  const detailsModal = document.getElementById("detailsModal");
  const detailsBody  = document.getElementById("detailsBody");

  if (detailsBtn && detailsModal && detailsBody) {
    detailsBtn.addEventListener("click", () => {
      detailsBody.innerHTML = buildDetailsHTML();
      detailsModal.style.display = "flex";
    });
  }

  if (closeBtn && detailsModal) {
    closeBtn.addEventListener("click", () => {
      detailsModal.style.display = "none";
    });
  }
});
  // ğŸ” Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î¿Î¼Î¿Î¹ÏŒÏ„Î·Ï„Î±Ï‚ Î¼ÎµÏ„Î±Î¾Ï Î´ÏÎ¿ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÏ‰Î½ (Ï€Î¿Î»Ï Î±Ï€Î»ÏŒ heuristic)
function similarityScore(a, b) {
  if (!a || !b) return 0;
  const wordsA = new Set(a.split(/\s+/));
  const wordsB = new Set(b.split(/\s+/));
  const common = [...wordsA].filter(w => wordsB.has(w)).length;
  const score = common / Math.max(wordsA.size, wordsB.size);
  return score; // 0 = ÎºÎ±Î¼Î¯Î± Î¿Î¼Î¿Î¹ÏŒÏ„Î·Ï„Î±, 1 = Ï€Î±Î½Î¿Î¼Î¿Î¹ÏŒÏ„Ï…Ï€Î±
}

</script>

    <!-- ğŸ”¥ Î ÏÎ¿Î¸Î­ÏÎ¼Î±Î½ÏƒÎ· AI API -->
<script>
window.addEventListener("load", async () => {
  try {
    await fetch("/api/score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        transcript: "ping",
        mission: { title: "prewarm", question: "test" }
      })
    });
    console.log("âš¡ï¸ Î ÏÎ¿Î¸Î­ÏÎ¼Î±Î½ÏƒÎ· API Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ");
  } catch (err) {
    console.warn("Î ÏÎ¿Î¸Î­ÏÎ¼Î±Î½ÏƒÎ· Î±Ï€Î­Ï„Ï…Ï‡Îµ:", err);
  }
});
</script>
  
<!-- === MODAL Î‘ÎÎ‘ÎšÎŸÎ™ÎÎ©Î£Î—Î£ Î‘Î ÎŸÎ¤Î•Î›Î•Î£ÎœÎ‘Î¤ÎŸÎ£ === -->
<div id="resultModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:3000;
  color:white;
  font-family: system-ui, Arial;
  text-align:center;
  padding:20px;
">
  <div style="background:#142f70; border-radius:20px; padding:30px; max-width:600px; box-shadow:0 0 30px rgba(0,0,0,0.4);">
    <h2>ğŸ“œ Î— Î£ÎºÎ­ÏˆÎ· Ï„Î¿Ï… Î¦Î¹Î»Î¿ÏƒÏŒÏ†Î¿Ï…:</h2>
    <p id="socratesQuote" style="font-style:italic; font-size:1.2em; margin:20px 0;"></p>
    <h3>ğŸ“œ Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î± Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚</h3>
    <div id="resultsSummary" style="margin-top:10px;"></div>
<button id="showDetailsBtn" style="
  margin-top:15px;
  background:#6ee0ff;
  border:none;
  padding:10px 22px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
  color:#001;
">ğŸ“Š Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</button>
    
    <button id="nextMissionBtn" style="
      margin-top:25px;
      background:#f2c14e;
      border:none;
      padding:12px 25px;
      border-radius:10px;
      font-weight:bold;
      cursor:pointer;
      color:#000;

    ">Î•Ï€ÏŒÎ¼ÎµÎ½Î· Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
  </div>
</div>

  <!-- === MODAL Î‘ÎÎ‘Î›Î¥Î¤Î™ÎšÎ—Î£ Î’Î‘Î˜ÎœÎŸÎ›ÎŸÎ“Î™Î‘Î£ === -->
<div id="detailsModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:3500;
  color:white;
  font-family:system-ui,Arial;
  text-align:center;
  padding:20px;
">
  <div style="
    background:#1a357a;
    border-radius:20px;
    padding:30px;
    max-width:600px;
    width:100%;
    box-shadow:0 0 30px rgba(0,0,0,0.4);
  ">
    <h2>ğŸ“Š Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯Î±</h2>
    <div id="detailsBody" style="margin-top:15px;text-align:left;"></div>
    <button id="closeDetailsBtn" style="
      margin-top:25px;
      background:#6ee0ff;
      border:none;
      padding:12px 25px;
      border-radius:10px;
      font-weight:bold;
      cursor:pointer;
      color:#001;
    ">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>
</div>

  <!-- Popup Î£Ï‡Î¿Î»Î¯Î¿Ï… Î£Ï‰ÎºÏÎ¬Ï„Î· -->
<div id="socratesPopup" style="
  display:none;
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(255,255,255,0.15);
  border:2px solid #6ee0ff;
  border-radius:15px;
  padding:12px 18px;
  color:#fff;
  font-size:16px;
  text-align:center;
  backdrop-filter:blur(4px);
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  z-index: 4000;
">
  ğŸ’¬ <span id="socratesPopupText"></span>
</div>

<script>
window.addEventListener('load', () => {
  try {
    fetch("/api/score?warmup=1", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        transcript: "ok",
        mission: { title: "-", question: "-" },
        warmup: true
      })
    }).catch(() => {});
  } catch (e) {}
});
</script>

<!-- === MANUAL SCORING MODAL (Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ) === -->
<div id="manualModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:4000;
  color:white;
  font-family:system-ui,Arial;
  text-align:center;
  padding:20px;
">
  <div style="
    background:#1a357a;
    border-radius:20px;
    padding:30px;
    max-width:500px;
    width:100%;
    box-shadow:0 0 30px rgba(0,0,0,0.4);
  ">
    <h2>ğŸ‘¤ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿Ï‚ ÎšÏÎ¹Ï„Î®Ï‚</h2>
    <p>ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎµ Ï„Î¿Ï…Ï‚ Î²Î±Î¸Î¼Î¿ÏÏ‚ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î±.</p>
    <div id="manualInputs" style="margin-top:15px;"></div>
    <div style="margin-top:25px;">
      <button id="manualSubmit" style="background:#6ee0ff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;color:#001;font-weight:bold;">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·</button>
      <button id="manualCancel" style="background:#ef476f;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;color:#fff;font-weight:bold;margin-left:10px;">Î†ÎºÏ…ÏÎ¿</button>
    </div>
  </div>
</div>
<!-- === Version Tag === -->
<div id="versionTag"
     style="
       position: fixed;
       bottom: 6px;
       right: 10px;
       color: #fff;
       font-size: 13px;
       opacity: 0.9;
       font-family: monospace;
       background: rgba(0,0,0,0.6);
       padding: 3px 8px;
       border-radius: 6px;
       z-index: 999999;
     ">
</div>

<script>
  const currentVersion = "v1.3-stable";
  document.getElementById("versionTag").textContent = currentVersion;
  console.log("âœ… ÎˆÎºÎ´Î¿ÏƒÎ· ÎµÎ¼Ï†Î±Î½Î¯ÏƒÏ„Î·ÎºÎµ:", currentVersion);
</script>

    <script>
window.addEventListener("DOMContentLoaded", () => {
  const infoBtn = document.getElementById("infoButton");

  if (infoBtn) {
    infoBtn.addEventListener("click", () => {
      alert("ğŸ“œ ÎŸÎ´Î·Î³Î¯ÎµÏ‚ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï:\n\n1ï¸âƒ£ Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ ÎºÎ±Î¹ Î³ÏÏÎ¿Ï…Ï‚.\n2ï¸âƒ£ ÎœÎ¯Î»Î± Î® Î³ÏÎ¬ÏˆÎµ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Ï„Î¿Ï… Ï€Î±Î¯ÎºÏ„Î·.\n3ï¸âƒ£ ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ Î¸Î± Ï„Î· Î²Î±Î¸Î¼Î¿Î»Î¿Î³Î®ÏƒÎµÎ¹ ÎºÎ±Î¹ Î¸Î± ÏƒÏ‡Î¿Î»Î¹Î¬ÏƒÎµÎ¹.\n\nÎšÎ±Î»Î® Î´Î¹Î±ÏƒÎºÎ­Î´Î±ÏƒÎ·!");
    });
  }

  console.log("âœ… Info button ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ.");
});

/* ==========================================================
   ğŸ² ÎšÎŸÎ¥ÎœÎ Î™ Î Î‘Î¡Î‘Î”Î•Î™Î“ÎœÎ‘ + Î‘Î¥Î¤ÎŸÎœÎ‘Î¤Î— Î‘ÎÎ™ÎŸÎ›ÎŸÎ“Î—Î£Î— Î£Î©ÎšÎ¡Î‘Î¤Î—
   ========================================================== */

/* ---------- Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· ÎšÎ¬ÏÏ„Î±Ï‚ Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ + Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ---------- */
async function showExample() {
  try {
    const missionId = currentMissionId || "M-101";
    const words = await loadExampleWords(missionId);

    if (words.length === 0) {
      alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼ÎµÏ‚ ÎºÎ¬ÏÏ„ÎµÏ‚ Ï€Î±ÏÎ±Î´ÎµÎ¹Î³Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®.");
      return;
    }

    // ğŸ² Î¤Ï…Ï‡Î±Î¯Î± ÎµÏ€Î¹Î»Î¿Î³Î® Î¼Î¹Î±Ï‚ 3Î¬Î´Î±Ï‚ Î»Î­Î¾ÎµÏ‰Î½
    const trio = words[Math.floor(Math.random() * words.length)];
    const exampleText = `ğŸ² ÎŸÎ¹ Î»Î­Î¾ÎµÎ¹Ï‚ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹: ${trio.join(" â€“ ")}`;
    console.log(exampleText);
    alert(exampleText);

    // ğŸ™ï¸ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ®Ï‚ Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·Ï‚
    if (typeof startSpeechRecognition === "function") {
      console.log("ğŸ¤ Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î· Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ· Î³Î¹Î± Ï„Î¿ Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±...");
      startSpeechRecognition(async (spokenText) => {

        console.log("ğŸ—£ï¸ Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï€Î¿Ï… ÎµÎ¹Ï€ÏÎ¸Î·ÎºÎµ:", spokenText);

        // âœ¨ Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Ï„Î¿ Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î³Î¹Î± Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Î£Ï‰ÎºÏÎ¬Ï„Î·
        const feedback = await getExampleFeedback(spokenText, trio);

        alert(`ğŸ’¬ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚: ${feedback}`);
      });
    } else {
      console.warn("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· startSpeechRecognition().");
    }

  } catch (err) {
    console.error("âš ï¸ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· ÎºÎ¬ÏÏ„Î±Ï‚ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚:", err);
  }
}


/* ---------- Î£Ï‰ÎºÏÎ±Ï„Î¹ÎºÎ® Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ ---------- */
async function getExampleFeedback(spokenText, trioWords) {
  try {
    const prompt = `
Î•Î¯ÏƒÎ±Î¹ Î¿ Ï†Î¹Î»ÏŒÏƒÎ¿Ï†Î¿Ï‚ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚.
ÎŸ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼ÏŒÎ»Î¹Ï‚ Î­Î´Ï‰ÏƒÎµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¹Ï‚ Î»Î­Î¾ÎµÎ¹Ï‚: ${trioWords.join(", ")}.
Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ­ Ï„Î¿ ÏƒÏÎ½Ï„Î¿Î¼Î± (1 Ï€ÏÏŒÏ„Î±ÏƒÎ·) Î±Î½ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÏƒÏ‡ÎµÏ„Î¯Î¶ÎµÏ„Î±Î¹ Î¿Ï…ÏƒÎ¹Î±ÏƒÏ„Î¹ÎºÎ¬ Î¼Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î­Î½Î½Î¿Î¹ÎµÏ‚.
ÎÎ± Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ Ï‰Ï‚ "Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚" Î¼Îµ Î¸ÎµÏ„Î¹ÎºÏŒ Î® Î´Î¹Î¿ÏÎ¸Ï‰Ï„Î¹ÎºÏŒ Ï„ÏŒÎ½Î¿, Ï‡Ï‰ÏÎ¯Ï‚ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚.
Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î¼Î±Î¸Î·Ï„Î®: "${spokenText}"`;

    const response = await fetch("/api/score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        transcript: spokenText,
        mission: { question: "Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎµ Î¼ÏŒÎ½Î¿ Ï„Î· Ï‡ÏÎ®ÏƒÎ· Ï„Î¿Ï… Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚" },
        mode: "example"
      })
    });

    if (!response.ok) {
      console.error("âŒ API error Î³Î¹Î± Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±:", response.status);
      return "Î”ÎµÎ½ ÎºÎ±Ï„Î¬Î»Î±Î²Î± Ï€Î»Î®ÏÏ‰Ï‚ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î¬ ÏƒÎ¿Ï… â€” Î³Î¹Î± Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î¾Î±Î½Î¬!";
    }

    const data = await response.json();
    console.log("ğŸ“¨ Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· Î£Ï‰ÎºÏÎ¬Ï„Î· (Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±):", data);
    return data.feedback || "ÎšÎ±Î»Î® Î±ÏÏ‡Î®, Î±Î»Î»Î¬ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€Î¹Î¿ ÏƒÎ±Ï†Î®Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ·.";
  } catch (err) {
    console.error("âš ï¸ Î£Ï†Î¬Î»Î¼Î± Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚:", err);
    return "ÎŸ Î£Ï‰ÎºÏÎ¬Ï„Î·Ï‚ ÏƒÏ…Î»Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Î±ÎºÏŒÎ¼Î· Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±...";
  }
}

      
</script>

<script type="module" src="utils/trialsEngine.js?v=2"></script>
  
</body>
</html>


